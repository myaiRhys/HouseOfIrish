<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#191919">
    <meta name="description" content="Thibault - Home Management App">
    <title>Thibault</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">

    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="./icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="72x72" href="./icons/icon-72x72.png">
    <link rel="apple-touch-icon" sizes="96x96" href="./icons/icon-96x96.png">
    <link rel="apple-touch-icon" sizes="128x128" href="./icons/icon-128x128.png">
    <link rel="apple-touch-icon" sizes="144x144" href="./icons/icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="./icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="192x192" href="./icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="384x384" href="./icons/icon-384x384.png">
    <link rel="apple-touch-icon" sizes="512x512" href="./icons/icon-512x512.png">

    <!-- Apple Mobile Web App -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="HOI">

    <!-- Microsoft Tiles -->
    <meta name="msapplication-TileColor" content="#191919">
    <meta name="msapplication-TileImage" content="/icons/icon-144x144.png">

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* ========================================
           CSS RESET & BASE STYLES
           ======================================== */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 22px;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, 'Apple Color Emoji', Arial, sans-serif, 'Segoe UI Emoji', 'Segoe UI Symbol';
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            min-height: 100vh;
            padding-bottom: 80px;
            overflow-x: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ========================================
           THEME VARIABLES (CSS Custom Properties)
           Notion-style Dark Theme
           ======================================== */
        :root {
            /* Dark Theme (Default) - Notion Style */
            --primary: #37C5AB;
            --primary-dark: #2EA58E;
            --secondary: #529CCA;
            --accent: #529CCA;
            --warning: #E9B949;
            --danger: #E16259;
            --danger-soft: #3E2C2A;
            --bg: #191919;
            --card: #252525;
            --text: #E3E2E0;
            --text-light: #9B9A97;
            --text-muted: #6C6C6C;
            --border: #37352F;
            --border-light: #3F3F3F;
            --shadow: 0 1px 3px rgba(0,0,0,0.4);
            --shadow-lg: 0 4px 12px rgba(0,0,0,0.5);
            --radius: 6px;
            --radius-sm: 4px;
            --badge-member-bg: #2B3A36;
            --badge-member-color: #7FD1BF;
            --badge-member-border: #37C5AB;
            --badge-due-bg: #3E362A;
            --badge-due-color: #E9B949;
            --badge-due-border: #C99532;
        }

        /* Light Theme - Notion Style */
        [data-theme="light"] {
            --primary: #2EAADC;
            --primary-dark: #2590BD;
            --secondary: #46B29D;
            --accent: #2EAADC;
            --warning: #E9B949;
            --danger: #E16259;
            --danger-soft: #FCE8E6;
            --bg: #FFFFFF;
            --card: #FBFBFA;
            --text: #37352F;
            --text-light: #787774;
            --text-muted: #9B9A97;
            --border: #E9E9E7;
            --border-light: #F1F1EF;
            --shadow: 0 1px 2px rgba(0,0,0,0.06);
            --shadow-lg: 0 4px 8px rgba(0,0,0,0.08);
            --badge-member-bg: #E4F4F0;
            --badge-member-color: #2C8570;
            --badge-member-border: #B4E4D8;
            --badge-due-bg: #FDF6E9;
            --badge-due-color: #9F6B0F;
            --badge-due-border: #EDD899;
        }

        /* ========================================
           TYPOGRAPHY
           ======================================== */
        h1, h2, h3, h4 {
            font-weight: 700;
            line-height: 1.3;
        }

        h1 { font-size: 1.5rem; }
        h2 { font-size: 1.25rem; }
        h3 { font-size: 1.1rem; }

        /* ========================================
           LAYOUT COMPONENTS
           ======================================== */
        .app-header {
            background: var(--card);
            padding: 8px 16px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-header h1 {
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 1.1rem;
        }

        .pwa-install-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            padding: 8px 12px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
            animation: pulse 2s infinite;
        }

        .pwa-install-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        main {
            padding: 16px;
            max-width: 600px;
            margin: 0 auto;
        }

        .page {
            display: none;
            animation: fadeIn 0.2s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ========================================
           BOTTOM NAVIGATION
           ======================================== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            padding: 8px 4px;
            padding-bottom: max(8px, env(safe-area-inset-bottom));
            z-index: 1000;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .nav-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 4px;
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 0.65rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
            min-height: 60px;
        }

        .nav-btn:focus {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        .nav-btn .icon {
            font-size: 1.4rem;
        }

        .nav-btn.active {
            color: var(--primary);
            background: rgba(16, 185, 129, 0.1);
        }

        .nav-btn:active {
            transform: scale(0.95);
        }

        /* ========================================
           CARDS
           ======================================== */
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s ease;
        }

        .card:hover {
            border-color: var(--border-light);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        /* ========================================
           STAT CARDS (Dashboard)
           ======================================== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin-bottom: 12px;
        }

        .stat-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 8px 6px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            border-color: var(--border-light);
            transform: translateY(-1px);
        }

        .stat-icon-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            font-size: 1rem;
            background: var(--border);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            margin-bottom: 4px;
            transition: all 0.2s ease;
        }

        .stat-icon-btn:hover {
            background: var(--primary);
            transform: scale(1.1);
        }

        .stat-icon-btn:focus {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        .stat-icon-btn:active {
            transform: scale(0.95);
        }

        .stat-card .stat-title {
            font-size: 0.6rem;
            color: var(--text-light);
            margin-bottom: 2px;
        }

        .stat-card .stat-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--warning);
        }

        .stat-card .stat-label {
            font-size: 0.55rem;
            color: var(--text-light);
        }

        /* ========================================
           FORMS
           ======================================== */
        .add-form {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 16px;
            margin-bottom: 16px;
            display: none;
            transition: background-color 0.3s ease;
        }

        .add-form.open {
            display: block;
            animation: slideDown 0.2s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-light);
            margin-bottom: 6px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            font-size: 0.95rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--card);
            color: var(--text);
            transition: all 0.15s ease;
        }

        .form-group input:hover,
        .form-group select:hover,
        .form-group textarea:hover {
            border-color: var(--border-light);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        /* ========================================
           BUTTONS
           ======================================== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 16px;
            font-size: 0.9rem;
            font-weight: 500;
            border: 1px solid transparent;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.15s ease;
            min-height: 44px;
        }

        .btn:focus {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            border-color: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--card);
            color: var(--text);
            border-color: var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg);
            border-color: var(--border-light);
            transform: translateY(-1px);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-light);
            padding: 8px;
            min-height: 44px;
        }

        .btn-ghost:hover {
            background: var(--card);
            color: var(--text);
        }

        .btn-add {
            width: 100%;
            margin-bottom: 16px;
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 0.85rem;
            min-height: 44px;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .form-actions .btn {
            flex: 1;
        }

        /* ========================================
           LIST ITEMS (Compact)
           ======================================== */
        .list-section {
            margin-bottom: 16px;
        }

        .list-section h3 {
            color: var(--text-light);
            font-size: 0.85rem;
            margin-bottom: 8px;
            padding-left: 4px;
        }

        .list-item {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 10px 12px;
            margin-bottom: 6px;
            display: flex;
            gap: 10px;
            align-items: flex-start;
            transition: all 0.2s ease;
        }

        .list-item:hover {
            border-color: var(--border-light);
            background: var(--bg);
        }

        .list-item.completed {
            opacity: 0.6;
        }

        .list-item.completed .item-name {
            text-decoration: line-through;
            color: var(--text-light);
        }

        .item-checkbox {
            width: 28px;
            height: 28px;
            border: 2px solid var(--primary);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s ease;
            background: transparent;
            min-width: 28px;
            color: transparent;
        }

        .item-checkbox:hover {
            background: rgba(34, 197, 94, 0.1);
        }

        .item-checkbox.checked {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .item-checkbox:focus {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        .item-delete {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s ease;
            background: transparent;
            color: var(--text-light);
            font-size: 1.1rem;
            opacity: 0.6;
        }

        .item-delete:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            opacity: 1;
        }

        .item-delete:focus {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        .item-edit {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s ease;
            background: transparent;
            color: var(--text-light);
            font-size: 0.9rem;
            opacity: 0.6;
        }

        .item-edit:hover {
            background: rgba(34, 197, 94, 0.1);
            color: var(--primary);
            opacity: 1;
        }

        .item-edit:focus {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        .item-actions {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }

        .item-content {
            flex: 1;
            min-width: 0;
        }

        .item-name {
            font-weight: 600;
            font-size: 0.95rem;
            word-break: break-word;
        }

        .item-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 4px;
        }

        .item-notes {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 4px;
            padding: 6px 8px;
            background: var(--bg);
            border-radius: var(--radius-sm);
        }

        /* ========================================
           BADGES
           ======================================== */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            font-size: 0.65rem;
            font-weight: 600;
            border-radius: 20px;
            white-space: nowrap;
        }

        .badge-member {
            background: var(--badge-member-bg);
            color: var(--badge-member-color);
            border: 1px solid var(--badge-member-border);
        }

        .badge-due {
            background: var(--badge-due-bg);
            color: var(--badge-due-color);
            border: 1px solid var(--badge-due-border);
        }

        .badge-due.overdue {
            background: var(--danger-soft);
            color: #fca5a5;
            border: 1px solid #991b1b;
        }

        [data-theme="light"] .badge-due.overdue {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fca5a5;
        }

        .badge-due.today {
            background: #7c2d12;
            color: #fdba74;
            border: 1px solid #c2410c;
        }

        [data-theme="light"] .badge-due.today {
            background: #ffedd5;
            color: #c2410c;
            border: 1px solid #fdba74;
        }

        /* ========================================
           COLLAPSIBLE SECTION
           ======================================== */
        .collapsible-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            margin-bottom: 8px;
            transition: background-color 0.2s ease;
            min-height: 44px;
        }

        .collapsible-header:hover {
            background: var(--card);
        }

        .collapsible-header:focus {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        .collapsible-header h3 {
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .collapsible-toggle {
            font-size: 0.8rem;
            transition: transform 0.3s ease;
        }

        .collapsible-header.expanded .collapsible-toggle {
            transform: rotate(180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .collapsible-content.expanded {
            max-height: 2000px;
            transition: max-height 0.5s ease-in;
        }

        /* ========================================
           QUICK ADD BUTTONS
           ======================================== */
        .quick-add {
            margin-top: 20px;
        }

        .quick-add h4 {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 10px;
        }

        .quick-add-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 10px;
        }

        .quick-btn {
            padding: 8px 12px;
            font-size: 0.8rem;
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 44px;
            color: var(--text);
        }

        .quick-btn:hover {
            border-color: var(--primary);
            background: rgba(16, 185, 129, 0.05);
        }

        .quick-btn:active {
            transform: scale(0.95);
        }

        .quick-btn:focus {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        .manage-btn {
            font-size: 0.8rem;
            color: var(--accent);
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px 0;
            text-decoration: underline;
        }

        /* ========================================
           MEMBER CARDS (Settings)
           ======================================== */
        .members-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .member-card {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 16px;
            text-align: center;
            transition: background-color 0.3s ease;
            position: relative;
        }

        .member-remove {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            color: var(--text-light);
            font-size: 0.9rem;
            opacity: 0.6;
            transition: all 0.2s ease;
        }

        .member-remove:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            opacity: 1;
        }

        .member-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: 700;
            font-size: 1.1rem;
            color: white;
        }

        .member-avatar.john { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .member-avatar.sarah { background: linear-gradient(135deg, #ec4899, #be185d); }
        .member-avatar.mary { background: linear-gradient(135deg, #8b5cf6, #6d28d9); }
        .member-avatar.tom { background: linear-gradient(135deg, #10b981, #059669); }

        .member-name {
            font-weight: 700;
            margin-bottom: 2px;
        }

        /* ========================================
           MODAL
           ======================================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 2000;
        }

        .modal-overlay.open {
            display: flex;
        }

        .modal {
            background: var(--card);
            border-radius: var(--radius);
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            animation: modalIn 0.2s ease;
            transition: background-color 0.3s ease;
        }

        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 1.1rem;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--border);
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text);
            transition: background 0.2s ease;
        }

        .modal-close:hover {
            background: var(--card);
        }

        .modal-close:focus {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        .modal-body {
            padding: 16px;
        }

        /* ========================================
           MANAGE ITEMS LIST
           ======================================== */
        .manage-list {
            margin-bottom: 16px;
        }

        .manage-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--bg);
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
        }

        .manage-item span {
            font-weight: 500;
        }

        .manage-item button {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--danger-soft);
            color: var(--danger);
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .add-standard-form {
            display: flex;
            gap: 8px;
        }

        .add-standard-form input {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            background: var(--bg);
            color: var(--text);
        }

        .add-standard-form input:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* ========================================
           TOAST NOTIFICATIONS
           ======================================== */
        .toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3000;
        }

        .toast {
            background: var(--text);
            color: white;
            padding: 12px 20px;
            border-radius: var(--radius-sm);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: toastIn 0.3s ease;
            box-shadow: var(--shadow-lg);
        }

        .toast.success {
            background: var(--primary);
        }

        .toast.hiding {
            animation: toastOut 0.3s ease forwards;
        }

        @keyframes toastIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes toastOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }

        /* ========================================
           SETTINGS SECTIONS
           ======================================== */
        .settings-section {
            margin-bottom: 24px;
        }

        .settings-section h2 {
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .settings-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .settings-btn {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: var(--card);
            border: none;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            cursor: pointer;
            font-size: 1rem;
            text-align: left;
            transition: all 0.2s ease;
            color: var(--text);
        }

        .settings-btn:hover {
            box-shadow: var(--shadow-lg);
        }

        .settings-btn span {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-btn .arrow {
            color: var(--text-light);
        }

        /* Settings Form Controls */
        .settings-control {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 8px;
        }

        .settings-control label {
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .settings-control select {
            padding: 8px 12px;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg);
            color: var(--text);
            font-size: 0.9rem;
            cursor: pointer;
            min-width: 120px;
        }

        .settings-control select:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* ========================================
           DASHBOARD UPCOMING
           ======================================== */
        .upcoming-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        @media (max-width: 480px) {
            .upcoming-grid {
                grid-template-columns: 1fr;
            }
        }

        .dashboard-upcoming {
            margin-bottom: 0;
        }

        .dashboard-upcoming h3 {
            font-size: 0.85rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .upcoming-item {
            background: var(--card);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow);
            padding: 8px 10px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .upcoming-item .upcoming-icon {
            font-size: 1rem;
        }

        .upcoming-item .upcoming-content {
            flex: 1;
            min-width: 0;
        }

        .upcoming-item .upcoming-name {
            font-weight: 600;
            font-size: 0.8rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .upcoming-item .upcoming-meta {
            font-size: 0.65rem;
            color: var(--text-light);
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 2px;
        }

        .upcoming-item .upcoming-due {
            color: var(--warning);
            font-weight: 600;
        }

        .upcoming-item .upcoming-due.overdue {
            color: var(--danger);
        }

        .upcoming-item .upcoming-due.today {
            color: #fdba74;
        }

        /* ========================================
           EMPTY STATE
           ======================================== */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        /* ========================================
           UTILITY CLASSES
           ======================================== */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        .text-center { text-align: center; }
        .mb-0 { margin-bottom: 0; }
        .mt-16 { margin-top: 16px; }

        /* ========================================
           AUTH PAGES
           ======================================== */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: var(--bg);
        }

        .auth-card {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            padding: 32px 24px;
            width: 100%;
            max-width: 400px;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .auth-header .logo {
            font-size: 3rem;
            margin-bottom: 8px;
        }

        .auth-header h1 {
            color: var(--primary);
            font-size: 1.5rem;
            margin-bottom: 4px;
        }

        .auth-header p {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .auth-form .form-group {
            margin-bottom: 16px;
        }

        .auth-form .btn {
            width: 100%;
            margin-top: 8px;
        }

        .auth-switch {
            text-align: center;
            margin-top: 20px;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .auth-switch button {
            background: none;
            border: none;
            color: var(--primary);
            font-weight: 600;
            cursor: pointer;
            text-decoration: underline;
        }

        .auth-error {
            background: var(--danger-soft);
            color: var(--danger);
            padding: 12px;
            border-radius: var(--radius-sm);
            margin-bottom: 16px;
            font-size: 0.9rem;
            display: none;
        }

        .auth-error.show {
            display: block;
        }

        .auth-divider {
            display: flex;
            align-items: center;
            margin: 20px 0;
            color: var(--text-light);
            font-size: 0.85rem;
        }

        .auth-divider::before,
        .auth-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        .auth-divider span {
            padding: 0 12px;
        }

        /* Household Setup */
        .household-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 16px;
        }

        .household-option {
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .household-option:hover {
            border-color: var(--primary);
        }

        .household-option h3 {
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .household-option p {
            color: var(--text-light);
            font-size: 0.85rem;
            margin: 0;
        }

        .invite-code-display {
            background: var(--bg);
            border: 2px dashed var(--primary);
            border-radius: var(--radius);
            padding: 20px;
            text-align: center;
            margin: 16px 0;
        }

        .invite-code-display .code {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            letter-spacing: 4px;
            font-family: monospace;
        }

        .invite-code-display p {
            color: var(--text-light);
            font-size: 0.85rem;
            margin-top: 8px;
        }

        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .btn.loading {
            pointer-events: none;
            opacity: 0.7;
        }

        /* Hidden utility */
        .hidden {
            display: none !important;
        }

        /* Sync indicator */
        .sync-indicator {
            position: fixed;
            top: 60px;
            right: 16px;
            background: var(--card);
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: var(--shadow);
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sync-indicator.show {
            opacity: 1;
        }

        .sync-indicator.syncing {
            color: var(--warning);
        }

        .sync-indicator.synced {
            color: var(--primary);
        }

        .sync-indicator.offline {
            color: var(--danger);
        }

        /* ========================================
           SPLASH SCREEN
           ======================================== */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .splash-screen.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        .splash-logo {
            font-size: 5rem;
            animation: pulse 2s ease-in-out infinite;
        }

        .splash-title {
            margin-top: 1rem;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text);
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
        }

        /* ========================================
           DEBUG PANEL STYLES
           ======================================== */
        .debug-panel {
            position: fixed;
            top: 60px;
            right: 8px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            background: var(--card);
            border: 2px solid var(--warning);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            z-index: 9999;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .debug-panel.open {
            display: flex;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .debug-header {
            background: var(--warning);
            color: var(--bg);
            padding: 8px 12px;
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .debug-close-btn {
            background: none;
            border: none;
            color: var(--bg);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .debug-close-btn:hover {
            background: rgba(0,0,0,0.2);
        }

        .debug-body {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            font-size: 0.75rem;
        }

        .debug-section {
            margin-bottom: 12px;
            padding: 8px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
        }

        .debug-section-title {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 6px;
            font-size: 0.8rem;
        }

        .debug-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid var(--border);
        }

        .debug-row:last-child {
            border-bottom: none;
        }

        .debug-label {
            color: var(--text-light);
        }

        .debug-value {
            color: var(--text);
            font-weight: 500;
        }

        .debug-value.online {
            color: var(--primary);
        }

        .debug-value.offline {
            color: var(--danger);
        }

        .debug-value.reconnecting {
            color: var(--warning);
        }

        .debug-logs {
            max-height: 200px;
            overflow-y: auto;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 6px;
            font-family: monospace;
            font-size: 0.65rem;
        }

        .debug-log-entry {
            margin-bottom: 4px;
            padding: 4px;
            border-left: 2px solid var(--border);
            padding-left: 6px;
        }

        .debug-log-entry.error {
            border-left-color: var(--danger);
            background: rgba(225, 98, 89, 0.1);
        }

        .debug-log-entry.success {
            border-left-color: var(--primary);
            background: rgba(55, 197, 171, 0.1);
        }

        .debug-log-entry.warning {
            border-left-color: var(--warning);
            background: rgba(233, 185, 73, 0.1);
        }

        .debug-log-time {
            color: var(--text-muted);
            font-size: 0.6rem;
        }

        .debug-log-message {
            color: var(--text);
            word-wrap: break-word;
        }

        .debug-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .debug-btn {
            flex: 1;
            padding: 8px;
            font-size: 0.75rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .debug-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .debug-btn:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body>
    <!-- ========================================
         SPLASH SCREEN
         ======================================== -->
    <div id="splash-screen" class="splash-screen">
        <div class="splash-logo">üè†</div>
        <div class="splash-title">Thibault</div>
    </div>

    <!-- ========================================
         AUTH SCREENS
         ======================================== -->
    <div id="auth-screen" class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <div class="logo">üè†</div>
                <h1>Thibault</h1>
                <p id="auth-subtitle">Sign in to manage your household</p>
            </div>

            <div id="auth-error" class="auth-error"></div>

            <!-- Login Form -->
            <form id="login-form" class="auth-form">
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" required placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" required placeholder="Your password" minlength="6">
                </div>
                <button type="submit" class="btn btn-primary" id="login-btn">Sign In</button>
            </form>

            <!-- Signup Form -->
            <form id="signup-form" class="auth-form hidden">
                <div class="form-group">
                    <label for="signup-name">Your Name</label>
                    <input type="text" id="signup-name" required placeholder="John Smith">
                </div>
                <div class="form-group">
                    <label for="signup-email">Email</label>
                    <input type="email" id="signup-email" required placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label for="signup-password">Password</label>
                    <input type="password" id="signup-password" required placeholder="Min 6 characters" minlength="6">
                </div>
                <button type="submit" class="btn btn-primary" id="signup-btn">Create Account</button>
            </form>

            <!-- Household Setup -->
            <div id="household-setup" class="hidden">
                <div id="household-choice">
                    <p class="text-center" style="margin-bottom: 16px;">Welcome! Let's set up your household.</p>
                    <div class="household-options">
                        <div class="household-option" id="create-household-btn">
                            <h3>üè† Create Household</h3>
                            <p>Start a new household and invite family members</p>
                        </div>
                        <div class="household-option" id="join-household-btn">
                            <h3>üîó Join Household</h3>
                            <p>Join an existing household with an invite code</p>
                        </div>
                    </div>
                </div>

                <!-- Create Household Form -->
                <form id="create-household-form" class="auth-form hidden">
                    <div class="form-group">
                        <label for="household-name">Household Name</label>
                        <input type="text" id="household-name" required placeholder="e.g., The Smith Family">
                    </div>
                    <button type="submit" class="btn btn-primary">Create Household</button>
                    <button type="button" class="btn btn-secondary mt-16" id="back-to-choice">Back</button>
                </form>

                <!-- Household Created Success -->
                <div id="household-created" class="hidden">
                    <p class="text-center">Your household has been created!</p>
                    <div class="invite-code-display">
                        <div class="code" id="invite-code-display">------</div>
                        <p>Share this code with family members to join</p>
                    </div>
                    <button class="btn btn-primary" id="continue-to-app">Continue to App</button>
                </div>

                <!-- Join Household Form -->
                <form id="join-household-form" class="auth-form hidden">
                    <div class="form-group">
                        <label for="invite-code">Invite Code</label>
                        <input type="text" id="invite-code" required placeholder="Enter 6-character code" maxlength="6" style="text-transform: uppercase; letter-spacing: 2px; text-align: center; font-size: 1.2rem;">
                    </div>
                    <button type="submit" class="btn btn-primary">Join Household</button>
                    <button type="button" class="btn btn-secondary mt-16" id="back-to-choice-2">Back</button>
                </form>
            </div>

            <div class="auth-switch" id="auth-switch">
                <span id="switch-text">Don't have an account?</span>
                <button id="switch-to-signup">Sign Up</button>
            </div>
        </div>
    </div>

    <!-- ========================================
         SYNC INDICATOR
         ======================================== -->
    <div id="sync-indicator" class="sync-indicator">
        <span class="loading-spinner"></span>
        <span id="sync-text">Syncing...</span>
    </div>

    <!-- ========================================
         MAIN APP (hidden until authenticated)
         ======================================== -->
    <div id="main-app" class="hidden">
    <!-- ========================================
         HEADER
         ======================================== -->
    <header class="app-header">
        <h1>üè† <span data-i18n="appName">Thibault</span></h1>
        <button id="pwa-install-btn" class="pwa-install-btn hidden" title="Install App">üì≤</button>
    </header>

    <!-- ========================================
         MAIN CONTENT
         ======================================== -->
    <main>
        <!-- Dashboard Page -->
        <section id="page-dashboard" class="page active" aria-label="Dashboard">
            <h2 style="margin-bottom: 8px; font-size: 1rem;" data-i18n="overview">Overview</h2>
            <div class="stats-grid" id="dashboard-stats">
                <!-- Stats populated by JS -->
            </div>

            <div class="upcoming-grid">
                <div id="dashboard-upcoming-tasks" class="dashboard-upcoming">
                    <!-- Upcoming tasks populated by JS -->
                </div>

                <div id="dashboard-upcoming-clifford" class="dashboard-upcoming">
                    <!-- Upcoming Clifford tasks populated by JS -->
                </div>
            </div>
        </section>

        <!-- Shopping Page -->
        <section id="page-shopping" class="page" aria-label="Shopping List">
            <button class="btn btn-primary btn-add" id="btn-add-shopping" aria-expanded="false">
                + <span data-i18n="addItem">Add Item</span>
            </button>

            <form class="add-form" id="form-shopping" aria-label="Add shopping item">
                <div class="form-group">
                    <label for="shopping-name" data-i18n="itemName">Item Name *</label>
                    <input type="text" id="shopping-name" required data-i18n-placeholder="itemNamePlaceholder" placeholder="e.g., Full cream milk">
                </div>
                <div class="form-group">
                    <label for="shopping-notes" data-i18n="notesOptional">Notes (optional)</label>
                    <textarea id="shopping-notes" data-i18n-placeholder="notesPlaceholder" placeholder="Any additional details..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="btn-cancel-shopping" data-i18n="cancel">Cancel</button>
                    <button type="submit" class="btn btn-primary" data-i18n="addItem">Add Item</button>
                </div>
            </form>

            <div id="shopping-list" aria-live="polite" aria-relevant="additions removals">
                <!-- Items populated by JS -->
            </div>

            <div class="quick-add">
                <h4 data-i18n="quickAdd">Quick Add</h4>
                <div class="quick-add-grid" id="shopping-quick-btns">
                    <!-- Quick buttons populated by JS -->
                </div>
                <button class="manage-btn" id="manage-shopping-standards" data-i18n="manageStandardItems">Manage Standard Items</button>
            </div>
        </section>

        <!-- Tasks Page -->
        <section id="page-tasks" class="page" aria-label="Household Tasks">
            <button class="btn btn-primary btn-add" id="btn-add-task" aria-expanded="false">
                + <span data-i18n="addTask">Add Task</span>
            </button>

            <form class="add-form" id="form-task" aria-label="Add task">
                <div class="form-group">
                    <label for="task-name" data-i18n="taskName">Task Name *</label>
                    <input type="text" id="task-name" required data-i18n-placeholder="taskNamePlaceholder" placeholder="e.g., Water the garden">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="task-assignee" data-i18n="assignTo">Assign To</label>
                        <select id="task-assignee">
                            <option value="john">John</option>
                            <option value="sarah">Sarah</option>
                            <option value="mary">Mary</option>
                            <option value="tom">Tom</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="task-due" data-i18n="dueDate">Due Date</label>
                        <input type="date" id="task-due">
                    </div>
                </div>
                <div class="form-group">
                    <label for="task-notes" data-i18n="notesOptional">Notes (optional)</label>
                    <textarea id="task-notes" data-i18n-placeholder="notesPlaceholder" placeholder="Any additional details..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="btn-cancel-task" data-i18n="cancel">Cancel</button>
                    <button type="submit" class="btn btn-primary" data-i18n="addTask">Add Task</button>
                </div>
            </form>

            <div id="tasks-list" aria-live="polite" aria-relevant="additions removals">
                <!-- Tasks populated by JS -->
            </div>

            <div class="quick-add">
                <h4 data-i18n="quickAdd">Quick Add</h4>
                <div class="quick-add-grid" id="tasks-quick-btns">
                    <!-- Quick buttons populated by JS -->
                </div>
                <button class="manage-btn" id="manage-tasks-standards" data-i18n="manageStandardItems">Manage Standard Items</button>
            </div>
        </section>

        <!-- Clifford Page -->
        <section id="page-clifford" class="page" aria-label="Clifford's Tasks">
            <button class="btn btn-primary btn-add" id="btn-add-clifford" aria-expanded="false">
                + <span data-i18n="addTask">Add Task</span>
            </button>

            <form class="add-form" id="form-clifford" aria-label="Add Clifford task">
                <div class="form-group">
                    <label for="clifford-name" data-i18n="taskName">Task Name *</label>
                    <input type="text" id="clifford-name" required data-i18n-placeholder="cliffordTaskPlaceholder" placeholder="e.g., Buy nappies">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="clifford-assignee" data-i18n="assignTo">Assign To</label>
                        <select id="clifford-assignee">
                            <option value="john">John</option>
                            <option value="sarah">Sarah</option>
                            <option value="mary">Mary</option>
                            <option value="tom">Tom</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="clifford-due" data-i18n="dueDate">Due Date</label>
                        <input type="date" id="clifford-due">
                    </div>
                </div>
                <div class="form-group">
                    <label for="clifford-notes" data-i18n="notesOptional">Notes (optional)</label>
                    <textarea id="clifford-notes" data-i18n-placeholder="notesPlaceholder" placeholder="Any additional details..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="btn-cancel-clifford" data-i18n="cancel">Cancel</button>
                    <button type="submit" class="btn btn-primary" data-i18n="addTask">Add Task</button>
                </div>
            </form>

            <div id="clifford-list" aria-live="polite" aria-relevant="additions removals">
                <!-- Clifford tasks populated by JS -->
            </div>

            <div class="quick-add">
                <h4 data-i18n="quickAdd">Quick Add</h4>
                <div class="quick-add-grid" id="clifford-quick-btns">
                    <!-- Quick buttons populated by JS -->
                </div>
                <button class="manage-btn" id="manage-clifford-standards" data-i18n="manageStandardItems">Manage Standard Items</button>
            </div>
        </section>

        <!-- Settings Page -->
        <section id="page-settings" class="page" aria-label="Settings">
            <!-- PWA Settings -->
            <div class="settings-section">
                <h2>üì± App</h2>
                <div class="settings-buttons">
                    <button class="settings-btn" id="pwa-install-btn-settings">
                        <span>üì≤ Install App</span>
                        <span class="arrow">‚Üí</span>
                    </button>
                    <button class="settings-btn" id="pwa-notification-btn">
                        <span>üîî <span id="notification-status">Enable Notifications</span></span>
                        <span class="arrow">‚Üí</span>
                    </button>
                </div>
            </div>

            <!-- Language & Theme Settings -->
            <div class="settings-section">
                <h2>‚öôÔ∏è <span data-i18n="settings">Settings</span></h2>
                <div class="settings-control">
                    <label for="language-select">üåê <span data-i18n="language">Language</span></label>
                    <select id="language-select">
                        <option value="en">English</option>
                        <option value="af">Afrikaans</option>
                    </select>
                </div>
                <div class="settings-control">
                    <label for="theme-select">üé® <span data-i18n="theme">Theme</span></label>
                    <select id="theme-select">
                        <option value="dark" data-i18n="darkTheme">Dark</option>
                        <option value="light" data-i18n="lightTheme">Light</option>
                    </select>
                </div>
            </div>

            <!-- Quick Add Management -->
            <div class="settings-section">
                <h2>‚ö° <span data-i18n="quickAdd">Quick Add</span></h2>
                <div class="settings-buttons">
                    <button class="settings-btn" id="settings-shopping-standards">
                        <span>üõí <span data-i18n="shoppingQuickAdd">Shopping Quick Add</span></span>
                        <span class="arrow">‚Üí</span>
                    </button>
                    <button class="settings-btn" id="settings-tasks-standards">
                        <span>‚úì <span data-i18n="tasksQuickAdd">Tasks Quick Add</span></span>
                        <span class="arrow">‚Üí</span>
                    </button>
                    <button class="settings-btn" id="settings-clifford-standards">
                        <span>üë∂ <span data-i18n="cliffordQuickAdd">Clifford Quick Add</span></span>
                        <span class="arrow">‚Üí</span>
                    </button>
                </div>
            </div>

            <!-- Household Members -->
            <div class="settings-section">
                <h2>üë• <span data-i18n="householdMembers">Household Members</span></h2>
                <div class="members-grid" id="members-grid">
                    <!-- Members populated by JS -->
                </div>
            </div>

            <!-- Household Info & Logout -->
            <div class="settings-section">
                <h2>üè† Household</h2>
                <div class="settings-control">
                    <label>Invite Code</label>
                    <span id="settings-invite-code" style="font-family: monospace; font-weight: 700; letter-spacing: 2px;">------</span>
                </div>
                <button class="btn btn-secondary" id="btn-logout" style="width: 100%; margin-top: 12px;">
                    üö™ Sign Out
                </button>
            </div>
        </section>
    </main>

    <!-- ========================================
         DEBUG PANEL
         ======================================== -->
    <div id="debug-panel" class="debug-panel">
        <div class="debug-header">
            <span>üêõ Debug Panel</span>
            <button class="debug-close-btn" onclick="toggleDebugPanel()">‚úï</button>
        </div>
        <div class="debug-body">
            <div class="debug-section">
                <div class="debug-section-title">Connection Status</div>
                <div class="debug-row">
                    <span class="debug-label">Network:</span>
                    <span id="debug-network" class="debug-value online">-</span>
                </div>
                <div class="debug-row">
                    <span class="debug-label">Realtime:</span>
                    <span id="debug-realtime" class="debug-value">-</span>
                </div>
            </div>

            <div class="debug-section">
                <div class="debug-section-title">Session Info</div>
                <div class="debug-row">
                    <span class="debug-label">Expires:</span>
                    <span id="debug-session-expiry" class="debug-value">-</span>
                </div>
                <div class="debug-row">
                    <span class="debug-label">Last Refresh:</span>
                    <span id="debug-session-refresh" class="debug-value">-</span>
                </div>
            </div>

            <div class="debug-section">
                <div class="debug-section-title">Last Operations</div>
                <div class="debug-row">
                    <span class="debug-label">DB Operation:</span>
                    <span id="debug-last-db" class="debug-value">-</span>
                </div>
                <div class="debug-row">
                    <span class="debug-label">App Visibility:</span>
                    <span id="debug-visibility" class="debug-value">-</span>
                </div>
            </div>

            <div class="debug-section">
                <div class="debug-section-title">Recent Logs (Last 10)</div>
                <div id="debug-logs" class="debug-logs">
                    <div class="debug-log-entry">
                        <div class="debug-log-time">No logs yet</div>
                    </div>
                </div>
            </div>

            <div class="debug-actions">
                <button class="debug-btn" onclick="copyDebugLogs()">üìã Copy Logs</button>
                <button class="debug-btn" onclick="clearDebugLogs()">üóëÔ∏è Clear</button>
            </div>
        </div>
    </div>

    <!-- ========================================
         BOTTOM NAVIGATION
         ======================================== -->
    <nav class="bottom-nav" aria-label="Main navigation">
        <button class="nav-btn active" data-page="dashboard" aria-current="page">
            <span class="icon">üè†</span>
            <span data-i18n="dashboard">Dashboard</span>
        </button>
        <button class="nav-btn" data-page="shopping">
            <span class="icon">üõí</span>
            <span data-i18n="shopping">Shopping</span>
        </button>
        <button class="nav-btn" data-page="tasks">
            <span class="icon">‚úì</span>
            <span data-i18n="tasks">Tasks</span>
        </button>
        <button class="nav-btn" data-page="clifford">
            <span class="icon">üë∂</span>
            <span data-i18n="clifford">Clifford</span>
        </button>
        <button class="nav-btn" data-page="settings">
            <span class="icon">‚öôÔ∏è</span>
            <span data-i18n="settings">Settings</span>
        </button>
    </nav>

    <!-- ========================================
         MODAL (Manage Standard Items)
         ======================================== -->
    <div class="modal-overlay" id="modal-manage" aria-hidden="true">
        <div class="modal" role="dialog" aria-labelledby="modal-manage-title">
            <div class="modal-header">
                <h3 id="modal-manage-title" data-i18n="manageStandardItems">Manage Standard Items</h3>
                <button class="modal-close" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="manage-list" id="manage-list">
                    <!-- Items populated by JS -->
                </div>
                <div class="add-standard-form">
                    <input type="text" id="new-standard-name" data-i18n-placeholder="newItemName" placeholder="New item name">
                    <button class="btn btn-primary btn-sm" id="btn-add-standard" data-i18n="add">Add</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================
         EDIT ITEM MODAL
         ======================================== -->
    <div class="modal-overlay" id="modal-edit" aria-hidden="true">
        <div class="modal" role="dialog" aria-labelledby="modal-edit-title">
            <div class="modal-header">
                <h3 id="modal-edit-title">Edit Item</h3>
                <button class="modal-close" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-edit-item">
                    <div class="form-group">
                        <label for="edit-name">Name</label>
                        <input type="text" id="edit-name" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-notes">Notes</label>
                        <textarea id="edit-notes" rows="3"></textarea>
                    </div>
                    <div class="form-group" id="edit-assignee-group" style="display: none;">
                        <label for="edit-assignee">Assign to</label>
                        <select id="edit-assignee">
                            <option value="">Unassigned</option>
                        </select>
                    </div>
                    <div class="form-group" id="edit-due-group" style="display: none;">
                        <label for="edit-due">Due date</label>
                        <input type="date" id="edit-due">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="btn-cancel-edit">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ========================================
         TOAST CONTAINER
         ======================================== -->
    <div class="toast-container" id="toast-container" role="status" aria-live="polite" aria-atomic="true"></div>

    </div><!-- END main-app -->

    <!-- ========================================
         JAVASCRIPT
         ======================================== -->
    <script>
        // ========================================
        // SUPABASE CONFIGURATION
        // ========================================
        const SUPABASE_URL = 'https://gyutgfsdtsbbymhwrqka.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd5dXRnZnNkdHNiYnltaHdycWthIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NzM1MDgsImV4cCI6MjA3OTU0OTUwOH0.MT8uHkOR5nmnB1VqOXelaMUM24aWiTYISmGK4VcSt4g';

        // Initialize Supabase client with persistent auth and connection configuration
        let supabase = null;
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                auth: {
                    autoRefreshToken: true,
                    persistSession: true,
                    detectSessionInUrl: true,
                    storage: window.localStorage,
                    storageKey: 'hoi-supabase-auth'
                },
                db: {
                    schema: 'public'
                },
                global: {
                    headers: {
                        'X-Client-Info': 'thibault-pwa'
                    },
                    fetch: function(url, options) {
                        // Add timeout to all fetch requests (60 seconds)
                        const controller = new AbortController();
                        const timeout = setTimeout(() => controller.abort(), 60000);

                        return fetch(url, {
                            ...options,
                            signal: controller.signal
                        }).finally(() => clearTimeout(timeout));
                    }
                },
                realtime: {
                    params: {
                        eventsPerSecond: 10
                    },
                    timeout: 30000, // 30 second timeout for realtime operations
                    heartbeatIntervalMs: 15000, // Send heartbeat every 15 seconds to keep connection alive
                    reconnectAfterMs: function(tries) {
                        // Exponential backoff: 1s, 2s, 4s, 8s, max 30s
                        return Math.min(1000 * Math.pow(2, tries), 30000);
                    }
                }
            });
            console.log('‚úÖ Supabase client initialized with connection management');
        } catch (e) {
            console.warn('Supabase not available, running in offline mode');
        }

        // ========================================
        // DEBUG LOGGING SYSTEM
        // ========================================
        const DEBUG_LOG_KEY = 'hoi-debug-logs';
        const MAX_LOGS = 50;
        const DISPLAY_LOGS = 10;

        // Debug state
        const debugState = {
            logs: [],
            enabled: false
        };

        // Load existing logs from localStorage
        function loadDebugLogs() {
            try {
                const stored = localStorage.getItem(DEBUG_LOG_KEY);
                if (stored) {
                    debugState.logs = JSON.parse(stored);
                }
            } catch (e) {
                console.error('Failed to load debug logs:', e);
            }
        }

        // Save logs to localStorage
        function saveDebugLogs() {
            try {
                localStorage.setItem(DEBUG_LOG_KEY, JSON.stringify(debugState.logs));
            } catch (e) {
                console.error('Failed to save debug logs:', e);
            }
        }

        // Add a debug log entry
        function debugLog(message, type = 'info', data = null) {
            const timestamp = new Date().toISOString();
            const entry = {
                timestamp,
                message,
                type, // 'info', 'success', 'error', 'warning'
                data: data ? JSON.stringify(data) : null
            };

            debugState.logs.push(entry);

            // Keep only the last MAX_LOGS entries
            if (debugState.logs.length > MAX_LOGS) {
                debugState.logs = debugState.logs.slice(-MAX_LOGS);
            }

            saveDebugLogs();
            updateDebugPanel();

            // Also log to console for immediate visibility
            const emoji = {
                'info': '‚ÑπÔ∏è',
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è'
            }[type] || '‚ÑπÔ∏è';

            console.log(`${emoji} [DEBUG] ${message}`, data || '');
        }

        // Update the debug panel with current state
        function updateDebugPanel() {
            // Network status
            const networkEl = document.getElementById('debug-network');
            if (networkEl) {
                const isOnline = navigator.onLine;
                networkEl.textContent = isOnline ? 'Online' : 'Offline';
                networkEl.className = 'debug-value ' + (isOnline ? 'online' : 'offline');
            }

            // Realtime status
            const realtimeEl = document.getElementById('debug-realtime');
            if (realtimeEl && state) {
                const channelState = state.realtimeChannel ? state.realtimeChannel.state : 'no-channel';
                realtimeEl.textContent = channelState;
                realtimeEl.className = 'debug-value ' +
                    (channelState === 'joined' ? 'online' :
                     channelState === 'no-channel' ? 'offline' : 'reconnecting');
            }

            // Session expiry
            const expiryEl = document.getElementById('debug-session-expiry');
            if (expiryEl && state && state.user) {
                // We'll update this when we have session info
                if (state._sessionExpiresAt) {
                    const now = Date.now();
                    const timeLeft = state._sessionExpiresAt - now;
                    const minutes = Math.floor(timeLeft / 60000);
                    expiryEl.textContent = minutes > 0 ? `${minutes}m` : 'Expired';
                } else {
                    expiryEl.textContent = '-';
                }
            }

            // Last session refresh
            const refreshEl = document.getElementById('debug-session-refresh');
            if (refreshEl && state && state._lastSessionRefresh) {
                const ago = Date.now() - state._lastSessionRefresh;
                const seconds = Math.floor(ago / 1000);
                refreshEl.textContent = seconds < 60 ? `${seconds}s ago` : `${Math.floor(seconds / 60)}m ago`;
            }

            // Last DB operation
            const dbEl = document.getElementById('debug-last-db');
            if (dbEl && state && state._lastSuccessfulOperation) {
                const ago = Date.now() - state._lastSuccessfulOperation;
                const seconds = Math.floor(ago / 1000);
                dbEl.textContent = seconds < 60 ? `${seconds}s ago` : `${Math.floor(seconds / 60)}m ago`;
            }

            // Visibility
            const visEl = document.getElementById('debug-visibility');
            if (visEl) {
                visEl.textContent = document.hidden ? 'Hidden' : 'Visible';
            }

            // Logs
            const logsEl = document.getElementById('debug-logs');
            if (logsEl) {
                const recentLogs = debugState.logs.slice(-DISPLAY_LOGS).reverse();
                if (recentLogs.length === 0) {
                    logsEl.innerHTML = '<div class="debug-log-entry"><div class="debug-log-time">No logs yet</div></div>';
                } else {
                    logsEl.innerHTML = recentLogs.map(log => {
                        const time = new Date(log.timestamp).toLocaleTimeString();
                        return `
                            <div class="debug-log-entry ${log.type}">
                                <div class="debug-log-time">${time}</div>
                                <div class="debug-log-message">${log.message}</div>
                            </div>
                        `;
                    }).join('');
                }
            }
        }

        // Toggle debug panel
        function toggleDebugPanel() {
            const panel = document.getElementById('debug-panel');
            if (panel) {
                panel.classList.toggle('open');
                if (panel.classList.contains('open')) {
                    updateDebugPanel();
                    // Update panel every second while open
                    if (!debugState.updateInterval) {
                        debugState.updateInterval = setInterval(updateDebugPanel, 1000);
                    }
                } else {
                    if (debugState.updateInterval) {
                        clearInterval(debugState.updateInterval);
                        debugState.updateInterval = null;
                    }
                }
            }
        }

        // Copy debug logs to clipboard
        function copyDebugLogs() {
            const logs = debugState.logs.map(log => {
                const time = new Date(log.timestamp).toLocaleString();
                return `[${time}] ${log.type.toUpperCase()}: ${log.message}${log.data ? ' | Data: ' + log.data : ''}`;
            }).join('\n');

            const summaryInfo = `
=== DEBUG LOG SUMMARY ===
Generated: ${new Date().toLocaleString()}
Total Logs: ${debugState.logs.length}
Network: ${navigator.onLine ? 'Online' : 'Offline'}
User Agent: ${navigator.userAgent}

=== LOGS ===
${logs}
            `.trim();

            navigator.clipboard.writeText(summaryInfo).then(() => {
                alert('Debug logs copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy logs:', err);
                // Fallback: show in alert
                alert('Failed to copy. Logs:\n\n' + summaryInfo);
            });
        }

        // Clear debug logs
        function clearDebugLogs() {
            if (confirm('Clear all debug logs?')) {
                debugState.logs = [];
                saveDebugLogs();
                updateDebugPanel();
                debugLog('Debug logs cleared', 'info');
            }
        }

        // Triple-tap handler for header
        let headerTapCount = 0;
        let headerTapTimer = null;

        function setupDebugPanelTrigger() {
            const header = document.querySelector('.app-header h1');
            if (header) {
                header.addEventListener('click', function() {
                    headerTapCount++;

                    if (headerTapCount === 1) {
                        headerTapTimer = setTimeout(() => {
                            headerTapCount = 0;
                        }, 500);
                    } else if (headerTapCount === 3) {
                        clearTimeout(headerTapTimer);
                        headerTapCount = 0;
                        toggleDebugPanel();
                    }
                });
            }
        }

        // Initialize debug system
        loadDebugLogs();
        debugLog('Debug system initialized', 'success');

        // ========================================
        // TRANSLATIONS
        // ========================================
        const translations = {
            en: {
                // App
                appName: 'Thibault',
                overview: 'Overview',

                // Navigation
                dashboard: 'Dashboard',
                shopping: 'Shopping',
                tasks: 'Tasks',
                clifford: 'Clifford',
                settings: 'Settings',

                // Dashboard
                toBuy: 'To Buy',
                active: 'Active',

                // Forms
                addItem: 'Add Item',
                addTask: 'Add Task',
                cancel: 'Cancel',
                add: 'Add',
                itemName: 'Item Name *',
                taskName: 'Task Name *',
                assignTo: 'Assign To',
                dueDate: 'Due Date',
                notesOptional: 'Notes (optional)',
                itemNamePlaceholder: 'e.g., Full cream milk',
                taskNamePlaceholder: 'e.g., Water the garden',
                cliffordTaskPlaceholder: 'e.g., Buy nappies',
                notesPlaceholder: 'Any additional details...',
                newItemName: 'New item name',

                // Lists
                quickAdd: 'Quick Add',
                manageStandardItems: 'Manage Standard Items',
                purchased: 'Purchased',
                completed: 'Completed',
                activeTasks: 'Active Tasks',

                // Settings
                languageSettings: 'Language Settings',
                appearanceSettings: 'Appearance Settings',
                householdMembers: 'Household Members',
                language: 'Language',
                theme: 'Theme',
                darkTheme: 'Dark',
                lightTheme: 'Light',
                shoppingQuickAdd: 'Shopping Quick Add',
                tasksQuickAdd: 'Tasks Quick Add',
                cliffordQuickAdd: 'Clifford Quick Add',
                tasksCompleted: 'tasks completed',

                // Date labels
                today: 'Today',
                tomorrow: 'Tomorrow',
                overdue: 'Overdue',
                inDays: 'In {days} days',

                // Toast messages
                itemAdded: '{name} added!',
                markedPurchased: 'Marked as purchased!',
                markedNotPurchased: 'Marked as not purchased',
                taskCompleted: 'Task completed!',
                taskIncomplete: 'Task marked as incomplete',

                // Empty states
                noShoppingItems: 'No shopping items yet',
                noTasks: 'No tasks yet',
                noCliffordTasks: 'No tasks for Clifford yet',

                // Upcoming
                upcomingTasks: 'Upcoming Tasks',
                upcomingClifford: 'Upcoming for Clifford'
            },
            af: {
                // App
                appName: 'Huis van Irish',
                overview: 'Oorsig',

                // Navigation
                dashboard: 'Paneelbord',
                shopping: 'Inkopies',
                tasks: 'Take',
                clifford: 'Clifford',
                settings: 'Instellings',

                // Dashboard
                toBuy: 'Te Koop',
                active: 'Aktief',

                // Forms
                addItem: 'Voeg Item By',
                addTask: 'Voeg Taak By',
                cancel: 'Kanselleer',
                add: 'Voeg By',
                itemName: 'Item Naam *',
                taskName: 'Taak Naam *',
                assignTo: 'Ken Toe Aan',
                dueDate: 'Sperdatum',
                notesOptional: 'Notas (opsioneel)',
                itemNamePlaceholder: 'bv. Volroom melk',
                taskNamePlaceholder: 'bv. Nat die tuin',
                cliffordTaskPlaceholder: 'bv. Koop doeke',
                notesPlaceholder: 'Enige bykomende besonderhede...',
                newItemName: 'Nuwe item naam',

                // Lists
                quickAdd: 'Vinnig Byvoeg',
                manageStandardItems: 'Bestuur Standaard Items',
                purchased: 'Gekoop',
                completed: 'Voltooi',
                activeTasks: 'Aktiewe Take',

                // Settings
                languageSettings: 'Taal Instellings',
                appearanceSettings: 'Voorkoms Instellings',
                householdMembers: 'Huishouding Lede',
                language: 'Taal',
                theme: 'Tema',
                darkTheme: 'Donker',
                lightTheme: 'Lig',
                shoppingQuickAdd: 'Inkopies Vinnig Byvoeg',
                tasksQuickAdd: 'Take Vinnig Byvoeg',
                cliffordQuickAdd: 'Clifford Vinnig Byvoeg',
                tasksCompleted: 'take voltooi',

                // Date labels
                today: 'Vandag',
                tomorrow: 'M√¥re',
                overdue: 'Agterstallig',
                inDays: 'Oor {days} dae',

                // Toast messages
                itemAdded: '{name} bygevoeg!',
                markedPurchased: 'Gemerk as gekoop!',
                markedNotPurchased: 'Gemerk as nie gekoop nie',
                taskCompleted: 'Taak voltooi!',
                taskIncomplete: 'Taak gemerk as onvoltooi',

                // Empty states
                noShoppingItems: 'Geen inkopie items nog nie',
                noTasks: 'Geen take nog nie',
                noCliffordTasks: 'Geen take vir Clifford nog nie',

                // Upcoming
                upcomingTasks: 'Komende Take',
                upcomingClifford: 'Komende vir Clifford'
            }
        };

        // ========================================
        // APPLICATION STATE
        // ========================================
        const state = {
            // Auth state
            user: null,
            household: null,
            householdMembers: [],

            // Data
            shopping: [],
            tasks: [],
            clifford: [],
            members: [],
            quickAdd: {
                shopping: ['ü•õ Milk', 'üçû Bread', 'ü•ö Eggs', 'üß¥ Soap', 'üßª Toilet Paper', 'üêï Dog Food'],
                tasks: ['üêï Feed Dogs', 'üå± Water Garden', 'üóëÔ∏è Take Out Trash', 'üßπ Clean House', 'üëï Do Laundry', 'üõí Buy Groceries'],
                clifford: ['üíâ Vaccines due', 'üçº Buy formula', 'üë∂ Buy nappies', 'ü•Ñ Buy baby food', 'üë®‚Äç‚öïÔ∏è Doctor appointment', 'üõÅ Bath supplies', 'üß∏ Toys/activities', 'üìè Milestone check']
            },

            // Realtime subscription
            realtimeChannel: null,

            // Session tracking
            _lastSessionRefresh: null,
            _sessionExpiresAt: null,
            _lastHiddenAt: null,
            _isWakingUp: false,
            _lastSuccessfulOperation: null,

            // UI state
            currentManageType: null,
            editingItem: null, // { type: 'shopping'|'tasks'|'clifford', item: {...} }
            language: localStorage.getItem('hoi-language') || 'en',
            theme: localStorage.getItem('hoi-theme') || 'dark',
            collapsedSections: {
                shopping: true,
                tasks: true,
                clifford: true
            },
            isOnline: navigator.onLine,
            isSyncing: false
        };

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        }

        function escapeHtml(str) {
            if (!str) return '';
            var div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function t(key, replacements) {
            var text = translations[state.language][key] || translations['en'][key] || key;
            if (replacements) {
                Object.keys(replacements).forEach(function(k) {
                    text = text.replace('{' + k + '}', replacements[k]);
                });
            }
            return text;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            var today = new Date();
            today.setHours(0, 0, 0, 0);
            var tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            var itemDate = new Date(dateStr);
            itemDate.setHours(0, 0, 0, 0);

            if (itemDate.getTime() === today.getTime()) return t('today');
            if (itemDate.getTime() === tomorrow.getTime()) return t('tomorrow');
            if (itemDate < today) return t('overdue');

            var diff = Math.ceil((itemDate - today) / (1000 * 60 * 60 * 24));
            if (diff <= 7) return t('inDays', { days: diff });

            return itemDate.toLocaleDateString(state.language === 'af' ? 'af-ZA' : 'en-ZA', { day: 'numeric', month: 'short' });
        }

        function getDateClass(dateStr) {
            if (!dateStr) return '';
            var today = new Date();
            today.setHours(0, 0, 0, 0);
            var itemDate = new Date(dateStr);
            itemDate.setHours(0, 0, 0, 0);

            if (itemDate < today) return 'overdue';
            if (itemDate.getTime() === today.getTime()) return 'today';
            return '';
        }

        function showToast(message, type) {
            type = type || 'success';
            var container = document.getElementById('toast-container');
            var toast = document.createElement('div');
            toast.className = 'toast ' + type;
            toast.textContent = '‚úì ' + message;
            container.appendChild(toast);

            setTimeout(function() {
                toast.classList.add('hiding');
                setTimeout(function() { toast.remove(); }, 300);
            }, 2000);
        }

        function getRelativeDate(daysFromNow) {
            var date = new Date();
            date.setDate(date.getDate() + daysFromNow);
            return date.toISOString().split('T')[0];
        }

        // ========================================
        // DATA PERSISTENCE
        // ========================================
        function saveData() {
            try {
                localStorage.setItem('hoi-shopping', JSON.stringify(state.shopping));
                localStorage.setItem('hoi-tasks', JSON.stringify(state.tasks));
                localStorage.setItem('hoi-clifford', JSON.stringify(state.clifford));
                localStorage.setItem('hoi-quickAdd', JSON.stringify(state.quickAdd));
            } catch (e) {
                console.warn('Failed to save data to localStorage:', e);
            }
        }

        function loadData() {
            try {
                var shopping = localStorage.getItem('hoi-shopping');
                var tasks = localStorage.getItem('hoi-tasks');
                var clifford = localStorage.getItem('hoi-clifford');
                var quickAdd = localStorage.getItem('hoi-quickAdd');

                if (shopping) state.shopping = JSON.parse(shopping);
                if (tasks) state.tasks = JSON.parse(tasks);
                if (clifford) state.clifford = JSON.parse(clifford);
                if (quickAdd) state.quickAdd = JSON.parse(quickAdd);

                return shopping || tasks || clifford;
            } catch (e) {
                console.warn('Failed to load data from localStorage:', e);
                return false;
            }
        }

        // ========================================
        // SYNC INDICATOR
        // ========================================
        function showSyncStatus(status, text) {
            var indicator = document.getElementById('sync-indicator');
            var textEl = document.getElementById('sync-text');
            indicator.className = 'sync-indicator show ' + status;
            textEl.textContent = text;
            if (status !== 'syncing') {
                setTimeout(function() { indicator.classList.remove('show'); }, 2000);
            }
        }

        // ========================================
        // AUTHENTICATION FUNCTIONS
        // ========================================
        async function handleLogin(email, password) {
            if (!supabase) {
                showAuthError('Offline mode - please check your connection');
                return false;
            }
            try {
                console.log('üîê Attempting login for:', email);
                var result = await supabase.auth.signInWithPassword({ email: email, password: password });
                if (result.error) throw result.error;

                console.log('‚úÖ Login successful, session stored in localStorage');
                console.log('üì¶ Session data:', result.data.session ? 'Present' : 'Missing');

                return true;
            } catch (e) {
                console.error('‚ùå Login failed:', e.message);
                showAuthError(e.message || 'Login failed');
                return false;
            }
        }

        async function handleSignup(email, password, name) {
            if (!supabase) {
                showAuthError('Offline mode - please check your connection');
                return false;
            }
            try {
                var result = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: { data: { name: name } }
                });
                if (result.error) throw result.error;
                localStorage.setItem('hoi-user-name', name);
                return true;
            } catch (e) {
                showAuthError(e.message || 'Signup failed');
                return false;
            }
        }

        // Helper function to add timeout to promises
        function withTimeout(promise, timeoutMs, errorMessage) {
            return Promise.race([
                promise,
                new Promise(function(_, reject) {
                    setTimeout(function() {
                        reject(new Error(errorMessage || 'Operation timed out'));
                    }, timeoutMs);
                })
            ]);
        }

        // Helper function to ensure session is fresh before database operations
        // CRITICAL: This now actually refreshes tokens, not just gets cached session
        async function ensureFreshSession() {
            console.log('üîç Checking session freshness...');
            debugLog('ensureFreshSession: Starting session check', 'info');

            if (!supabase) {
                console.error('‚ùå Supabase client not initialized');
                debugLog('ensureFreshSession: Supabase client not initialized', 'error');
                throw new Error('Supabase not available');
            }

            if (!state.user) {
                console.error('‚ùå No user in state');
                debugLog('ensureFreshSession: No user in state', 'error');
                throw new Error('Not authenticated');
            }

            try {
                // First check the cached session to see if we need to refresh
                debugLog('ensureFreshSession: Getting cached session', 'info');
                const { data: { session }, error } = await supabase.auth.getSession();

                if (error || !session) {
                    console.error('‚ùå Session check error or no session:', error);
                    debugLog('ensureFreshSession: No valid session found', 'error', { error: error?.message });
                    throw new Error('Session expired - please log in again');
                }

                const now = Date.now();
                const expiresAt = session.expires_at * 1000; // Convert to milliseconds
                const timeUntilExpiry = expiresAt - now;
                const timeSinceLastRefresh = state._lastSessionRefresh ? (now - state._lastSessionRefresh) : Infinity;

                // Track session expiry for debug panel
                state._sessionExpiresAt = expiresAt;

                // Refresh if: token expires within 5 minutes OR hasn't been refreshed in 10 minutes
                const FIVE_MINUTES = 5 * 60 * 1000;
                const TEN_MINUTES = 10 * 60 * 1000;
                const shouldRefresh = timeUntilExpiry < FIVE_MINUTES || timeSinceLastRefresh > TEN_MINUTES;

                const sessionInfo = {
                    expiresIn: Math.round(timeUntilExpiry / 1000) + 's',
                    timeSinceLastRefresh: state._lastSessionRefresh ? Math.round(timeSinceLastRefresh / 1000) + 's' : 'never',
                    shouldRefresh: shouldRefresh
                };
                debugLog('ensureFreshSession: Session status', 'info', sessionInfo);

                if (shouldRefresh) {
                    console.log('üîÑ Token needs refresh:', {
                        expiresIn: Math.round(timeUntilExpiry / 1000) + 's',
                        timeSinceLastRefresh: state._lastSessionRefresh ? Math.round(timeSinceLastRefresh / 1000) + 's' : 'never'
                    });
                    debugLog('ensureFreshSession: Starting session refresh', 'warning');

                    // Use refreshSession() to actually validate with server
                    // Note: refreshSession() automatically updates the client's internal session
                    const { data: refreshData, error: refreshError } = await supabase.auth.refreshSession();

                    if (refreshError) {
                        console.error('‚ùå Session refresh failed:', refreshError);
                        debugLog('ensureFreshSession: Refresh failed', 'error', { error: refreshError.message });

                        // Handle invalid_grant error (refresh token invalid/expired)
                        if (refreshError.message && refreshError.message.includes('invalid_grant')) {
                            throw new Error('Session expired - please log in again');
                        }

                        throw new Error('Session refresh failed: ' + refreshError.message);
                    }

                    if (!refreshData.session) {
                        console.error('‚ùå No session returned from refresh');
                        debugLog('ensureFreshSession: No session in refresh response', 'error');
                        throw new Error('Session expired - please log in again');
                    }

                    // refreshSession() already updates the Supabase client internally
                    // We just need to update our state
                    state.user = refreshData.session.user;
                    state._lastSessionRefresh = now;
                    state._sessionExpiresAt = refreshData.session.expires_at * 1000;

                    const refreshInfo = {
                        userId: refreshData.session.user.id,
                        newExpiresIn: Math.round((refreshData.session.expires_at * 1000 - now) / 1000) + 's'
                    };

                    console.log('‚úÖ Session refreshed successfully', {
                        userId: refreshData.session.user.id,
                        expiresAt: new Date(refreshData.session.expires_at * 1000).toLocaleString(),
                        newExpiresIn: Math.round((refreshData.session.expires_at * 1000 - now) / 1000) + 's'
                    });
                    debugLog('ensureFreshSession: Session refreshed successfully', 'success', refreshInfo);

                    return refreshData.session;
                } else {
                    // Session is still fresh, just update state
                    state.user = session.user;
                    state._sessionExpiresAt = expiresAt;
                    console.log('‚úÖ Session still fresh', {
                        userId: session.user.id,
                        expiresIn: Math.round(timeUntilExpiry / 1000) + 's'
                    });
                    debugLog('ensureFreshSession: Session still fresh', 'success', { expiresIn: Math.round(timeUntilExpiry / 1000) + 's' });
                    return session;
                }
            } catch (error) {
                console.error('‚ùå Error ensuring fresh session:', error);
                debugLog('ensureFreshSession: Error occurred', 'error', { error: error.message });
                throw error;
            }
        }

        // Wake up app after being backgrounded or idle
        // Forces full session refresh, DB test, and realtime reconnection
        async function wakeUpApp(retryCount = 0) {
            const MAX_RETRIES = 2;

            if (state._isWakingUp && retryCount === 0) {
                console.log('‚è∏Ô∏è Already waking up, waiting...');
                debugLog('wakeUpApp: Already in progress, waiting', 'warning');
                // Wait for current wake up to finish
                await new Promise(resolve => {
                    const checkInterval = setInterval(() => {
                        if (!state._isWakingUp) {
                            clearInterval(checkInterval);
                            resolve();
                        }
                    }, 100);
                    // Timeout after 10 seconds
                    setTimeout(() => {
                        clearInterval(checkInterval);
                        resolve();
                    }, 10000);
                });
                return;
            }

            state._isWakingUp = true;
            console.log('üåÖ Waking up app (attempt ' + (retryCount + 1) + '/' + (MAX_RETRIES + 1) + ')...');
            debugLog('wakeUpApp: Starting wake up', 'info', { attempt: retryCount + 1, maxRetries: MAX_RETRIES + 1 });
            showSyncStatus('syncing', 'Reconnecting...');

            try {
                // Small delay to let network stabilize after app switch
                if (retryCount === 0) {
                    console.log('‚è≥ Waiting for network to stabilize...');
                    debugLog('wakeUpApp: Waiting for network to stabilize', 'info');
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                // Step 1: Force token refresh with refreshSession()
                console.log('üîÑ Step 1: Force refreshing session...');
                debugLog('wakeUpApp: Step 1 - Refreshing session', 'info');
                const { data: refreshData, error: refreshError } = await supabase.auth.refreshSession();

                if (refreshError || !refreshData || !refreshData.session) {
                    console.error('‚ùå Session refresh failed during wakeup:', refreshError);
                    debugLog('wakeUpApp: Session refresh failed', 'error', { error: refreshError?.message });
                    if (retryCount < MAX_RETRIES) {
                        console.log('üîÑ Retrying wake up...');
                        debugLog('wakeUpApp: Retrying after session refresh failure', 'warning', { nextAttempt: retryCount + 2 });
                        state._isWakingUp = false;
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        return await wakeUpApp(retryCount + 1);
                    }
                    throw new Error('Session expired - please log in again');
                }

                // refreshSession() automatically updates the Supabase client
                state.user = refreshData.session.user;
                state._lastSessionRefresh = Date.now();
                state._sessionExpiresAt = refreshData.session.expires_at * 1000;
                console.log('‚úÖ Session refreshed successfully');
                debugLog('wakeUpApp: Step 1 complete - Session refreshed', 'success');

                // Step 2: Test DB connection with a simple query
                console.log('üîÑ Step 2: Testing database connection...');
                debugLog('wakeUpApp: Step 2 - Testing database connection', 'info');
                const testQuery = await Promise.race([
                    supabase.from('households').select('id').eq('id', state.household.id).limit(1),
                    new Promise((_, reject) => setTimeout(() => reject(new Error('DB test timeout')), 8000))
                ]);

                if (testQuery.error) {
                    console.error('‚ùå Database test failed:', testQuery.error);
                    debugLog('wakeUpApp: Database test failed', 'error', { error: testQuery.error.message });
                    if (retryCount < MAX_RETRIES) {
                        console.log('üîÑ Retrying wake up after DB failure...');
                        debugLog('wakeUpApp: Retrying after DB failure', 'warning', { nextAttempt: retryCount + 2 });
                        state._isWakingUp = false;
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        return await wakeUpApp(retryCount + 1);
                    }
                    throw new Error('Database connection failed');
                }

                console.log('‚úÖ Database connection active');
                debugLog('wakeUpApp: Step 2 complete - Database connected', 'success');

                // Step 3: Reconnect realtime subscriptions
                console.log('üîÑ Step 3: Reconnecting realtime...');
                debugLog('wakeUpApp: Step 3 - Reconnecting realtime', 'info');
                await setupRealtimeSubscriptions();
                console.log('‚úÖ Realtime reconnected');
                debugLog('wakeUpApp: Step 3 complete - Realtime reconnected', 'success');

                // Step 4: Reload data from Supabase
                console.log('üîÑ Step 4: Reloading data...');
                debugLog('wakeUpApp: Step 4 - Reloading data', 'info');
                await loadFromSupabase();

                state._lastSuccessfulOperation = Date.now();
                showSyncStatus('synced', 'Connected');
                console.log('‚úÖ App wake up complete');
                debugLog('wakeUpApp: Wake up complete - All steps successful', 'success');
            } catch (error) {
                console.error('‚ùå Wake up failed:', error);
                debugLog('wakeUpApp: Wake up failed', 'error', { error: error.message });
                showSyncStatus('offline', 'Connection failed');
                throw error;
            } finally {
                state._isWakingUp = false;
            }
        }

        async function handleLogout() {
            // Clean up realtime subscription
            if (state.realtimeChannel && supabase) {
                console.log('üîå Cleaning up realtime on logout...');
                try {
                    supabase.removeChannel(state.realtimeChannel);
                } catch (e) {
                    console.warn('Error removing channel on logout:', e);
                }
                state.realtimeChannel = null;
            }

            // Clear reconnect timer
            if (realtimeReconnectTimer) {
                clearTimeout(realtimeReconnectTimer);
                realtimeReconnectTimer = null;
            }
            realtimeReconnectAttempts = 0;

            if (supabase) {
                await supabase.auth.signOut();
            }
            // Clear all state
            state.user = null;
            state.household = null;
            state.members = [];
            state.shopping = [];
            state.tasks = [];
            state.clifford = [];
            state.quickAdd = { shopping: [], tasks: [], clifford: [] };
            // Clear localStorage
            localStorage.clear();
            showAuthScreen();
        }

        function showAuthError(message) {
            var errorEl = document.getElementById('auth-error');
            errorEl.textContent = message;
            errorEl.classList.add('show');
        }

        function hideAuthError() {
            document.getElementById('auth-error').classList.remove('show');
        }

        // ========================================
        // HOUSEHOLD FUNCTIONS
        // ========================================
        async function createHousehold(name) {
            if (!supabase || !state.user) return null;
            try {
                // Create household
                var result = await supabase.from('households').insert({
                    name: name,
                    created_by: state.user.id
                }).select().single();
                if (result.error) throw result.error;

                var household = result.data;

                // Add user as admin member
                var userName = localStorage.getItem('hoi-user-name') || state.user.email.split('@')[0];
                var initials = userName.split(' ').map(function(n) { return n[0]; }).join('').toUpperCase().substring(0, 2);

                var memberResult = await supabase.from('household_members').insert({
                    household_id: household.id,
                    user_id: state.user.id,
                    name: userName,
                    initials: initials,
                    is_admin: true
                }).select().single();
                if (memberResult.error) throw memberResult.error;

                // Initialize default quick add items
                var quickAddItems = [];
                ['shopping', 'tasks', 'clifford'].forEach(function(type) {
                    state.quickAdd[type].forEach(function(item, index) {
                        quickAddItems.push({
                            household_id: household.id,
                            type: type,
                            name: item,
                            sort_order: index
                        });
                    });
                });
                await supabase.from('quick_add').insert(quickAddItems);

                return household;
            } catch (e) {
                console.error('Failed to create household:', e);
                showAuthError(e.message || 'Failed to create household');
                return null;
            }
        }

        async function joinHousehold(inviteCode) {
            if (!supabase) {
                console.error('‚ùå joinHousehold failed: Supabase client is null');
                showAuthError('Database connection error. Please refresh the page.');
                return null;
            }

            if (!state.user) {
                console.error('‚ùå joinHousehold failed: No user logged in');
                showAuthError('Please log in first.');
                return null;
            }

            console.log('üè† Attempting to join household with code:', inviteCode);

            try {
                // Find household by invite code
                console.log('üîç Looking up household by invite code...');
                var result = await supabase.rpc('get_household_by_invite_code', { code: inviteCode.toUpperCase() });

                console.log('üîç Household lookup result:', result);

                if (result.error) {
                    console.error('‚ùå RPC error:', result.error);
                    throw result.error;
                }

                if (!result.data || result.data.length === 0) {
                    console.error('‚ùå No household found with code:', inviteCode);
                    throw new Error('Invalid invite code');
                }

                var household = result.data[0];
                console.log('‚úÖ Found household:', household);

                // Add user as member
                var userName = localStorage.getItem('hoi-user-name') || state.user.email.split('@')[0];
                var initials = userName.split(' ').map(function(n) { return n[0]; }).join('').toUpperCase().substring(0, 2);

                console.log('üë§ Adding user as member:', { userName, initials, userId: state.user.id, householdId: household.id });

                var memberResult = await supabase.from('household_members').insert({
                    household_id: household.id,
                    user_id: state.user.id,
                    name: userName,
                    initials: initials,
                    is_admin: false
                }).select().single();

                console.log('üë§ Member insert result:', memberResult);

                if (memberResult.error) {
                    console.error('‚ùå Member insert error:', memberResult.error);
                    throw memberResult.error;
                }

                console.log('‚úÖ Successfully joined household:', household.name);
                return household;
            } catch (e) {
                console.error('‚ùå Failed to join household:', e);
                showAuthError(e.message || 'Failed to join household');
                return null;
            }
        }

        async function getUserHousehold() {
            if (!supabase || !state.user) return null;
            try {
                var result = await supabase
                    .from('household_members')
                    .select('household_id, households(id, name, invite_code)')
                    .eq('user_id', state.user.id)
                    .limit(1)
                    .single();

                if (result.error && result.error.code !== 'PGRST116') throw result.error;
                if (result.data && result.data.households) {
                    return result.data.households;
                }
                return null;
            } catch (e) {
                console.error('Failed to get household:', e);
                return null;
            }
        }

        // ========================================
        // SUPABASE DATA OPERATIONS
        // ========================================
        async function loadFromSupabase() {
            if (!supabase || !state.household) return false;
            showSyncStatus('syncing', 'Loading...');
            try {
                var householdId = state.household.id;

                // Load all data in parallel
                var results = await Promise.all([
                    supabase.from('shopping').select('*').eq('household_id', householdId).order('created_at', { ascending: false }),
                    supabase.from('tasks').select('*').eq('household_id', householdId).order('created_at', { ascending: false }),
                    supabase.from('clifford').select('*').eq('household_id', householdId).order('created_at', { ascending: false }),
                    supabase.from('household_members').select('*').eq('household_id', householdId),
                    supabase.from('quick_add').select('*').eq('household_id', householdId).order('sort_order')
                ]);

                if (results[0].data) state.shopping = results[0].data.map(mapShoppingItem);
                if (results[1].data) state.tasks = results[1].data.map(mapTaskItem);
                if (results[2].data) state.clifford = results[2].data.map(mapTaskItem);
                if (results[3].data) state.members = results[3].data.map(mapMember);
                if (results[4].data) {
                    state.quickAdd = { shopping: [], tasks: [], clifford: [] };
                    results[4].data.forEach(function(item) {
                        if (state.quickAdd[item.type]) {
                            state.quickAdd[item.type].push(item.name);
                        }
                    });
                }

                saveData(); // Cache locally
                showSyncStatus('synced', 'Synced');
                return true;
            } catch (e) {
                console.error('Failed to load from Supabase:', e);
                showSyncStatus('offline', 'Sync failed');
                return false;
            }
        }

        function mapShoppingItem(item) {
            return {
                id: item.id,
                name: item.name,
                notes: item.notes || '',
                completed: item.completed
            };
        }

        function mapTaskItem(item) {
            return {
                id: item.id,
                name: item.name,
                notes: item.notes || '',
                assignee: item.assignee,
                due: item.due_date || '',
                completed: item.completed
            };
        }

        function mapMember(member) {
            return {
                id: member.id,
                user_id: member.user_id,
                name: member.name,
                initials: member.initials,
                role: member.role || 'Member'
            };
        }

        async function addShoppingToSupabase(item, retryCount = 0) {
            const MAX_RETRIES = 2;

            debugLog('addShopping: Function called', 'info', { itemName: item.name, attempt: retryCount + 1 });

            // Wait if app is waking up
            if (state._isWakingUp) {
                console.log('‚è∏Ô∏è Waiting for app to wake up...');
                debugLog('addShopping: Waiting for app wake up', 'warning');
                await new Promise(resolve => {
                    const checkInterval = setInterval(() => {
                        if (!state._isWakingUp) {
                            clearInterval(checkInterval);
                            resolve();
                        }
                    }, 100);
                });
            }

            if (!supabase) {
                console.error('‚ùå addShoppingToSupabase failed: Supabase client is null');
                debugLog('addShopping: Supabase client is null', 'error');
                showToast('Database connection error. Please refresh the page.');
                return false;
            }

            if (!state.household) {
                console.error('‚ùå addShoppingToSupabase failed: No household in state');
                debugLog('addShopping: No household in state', 'error');
                showToast('No household selected. Please refresh and try again.');
                return false;
            }

            if (!state.user || !state.user.id) {
                console.error('‚ùå addShoppingToSupabase failed: No user in state');
                debugLog('addShopping: No user in state', 'error');
                showToast('User session lost. Please refresh and log in again.');
                return false;
            }

            console.log('üöÄ Adding shopping to Supabase (attempt ' + (retryCount + 1) + '/' + (MAX_RETRIES + 1) + '):', {
                name: item.name,
                notes: item.notes,
                household_id: state.household.id,
                user_id: state.user.id
            });

            const channelState = state.realtimeChannel ? state.realtimeChannel.state : 'no-channel';
            debugLog('addShopping: Pre-insert state', 'info', {
                household: state.household.id,
                user: state.user.id,
                channelState: channelState
            });

            try {
                // Ensure session is fresh before database operation
                console.log('üîç Step 1: Ensuring fresh session...');
                debugLog('addShopping: Ensuring fresh session', 'info');
                const sessionStart = Date.now();
                await ensureFreshSession();
                console.log('‚úÖ Session ensured in', Date.now() - sessionStart, 'ms');
                debugLog('addShopping: Session ensured', 'success', { duration: Date.now() - sessionStart + 'ms' });

                console.log('‚è≥ Step 2: Executing INSERT query...');
                console.log('üìã Insert data:', {
                    household_id: state.household.id,
                    name: item.name,
                    user_id: state.user.id,
                    connection_status: state.realtimeChannel ? state.realtimeChannel.state : 'no channel'
                });
                debugLog('addShopping: Starting INSERT query', 'info', { itemName: item.name });

                const insertStart = Date.now();
                var insertPromise = supabase.from('shopping').insert({
                    household_id: state.household.id,
                    name: item.name,
                    notes: item.notes,
                    completed: item.completed,
                    created_by: state.user.id
                }).select().single();

                var result = await withTimeout(
                    insertPromise,
                    30000,
                    'Database insert timed out after 30 seconds'
                );

                const insertDuration = Date.now() - insertStart;
                console.log('üì¶ INSERT completed in', insertDuration, 'ms, result:', result);

                if (result.error) {
                    console.error('‚ùå Supabase shopping insert error:', result.error);
                    debugLog('addShopping: INSERT error', 'error', {
                        error: result.error.message,
                        code: result.error.code,
                        duration: insertDuration + 'ms'
                    });

                    // Check if it's an auth/permission error (42501, PGRST301, JWT)
                    const isAuthError = result.error.code === '42501' ||
                                       result.error.code === 'PGRST301' ||
                                       result.error.message.includes('policy') ||
                                       result.error.message.includes('JWT') ||
                                       result.error.message.includes('JWTExpired');

                    if (isAuthError && retryCount < MAX_RETRIES) {
                        console.log('üîÑ Auth error detected, forcing session refresh and retrying...');
                        debugLog('addShopping: Auth error, retrying', 'warning', { nextAttempt: retryCount + 2 });
                        // Force session refresh
                        const { data: refreshData } = await supabase.auth.refreshSession();
                        if (refreshData && refreshData.session) {
                            state.user = refreshData.session.user;
                            state._lastSessionRefresh = Date.now();
                            state._sessionExpiresAt = refreshData.session.expires_at * 1000;
                            // Retry
                            return await addShoppingToSupabase(item, retryCount + 1);
                        }
                    }

                    showToast('Failed to add item: ' + result.error.message);
                    return false;
                }

                if (result.data) {
                    item.id = result.data.id;
                    state._lastSuccessfulOperation = Date.now(); // Track successful operation
                    console.log('‚úÖ Shopping added successfully:', { id: result.data.id, name: item.name });
                    debugLog('addShopping: INSERT successful', 'success', {
                        itemName: item.name,
                        duration: insertDuration + 'ms'
                    });
                    return true;
                }

                console.error('‚ùå Supabase shopping insert returned no error and no data');
                debugLog('addShopping: No error and no data returned', 'error');
                return false;
            } catch (e) {
                console.error('‚ùå Failed to add shopping (exception):', e);
                debugLog('addShopping: Exception caught', 'error', { error: e.message });

                // Check if it's a timeout
                if (e.message && e.message.includes('timed out')) {
                    debugLog('addShopping: Timeout detected', 'warning');
                    if (retryCount < MAX_RETRIES) {
                        console.log('‚è±Ô∏è Timeout detected, waking up app and retrying...');
                        debugLog('addShopping: Attempting wake up after timeout', 'warning');
                        try {
                            await wakeUpApp();
                            return await addShoppingToSupabase(item, retryCount + 1);
                        } catch (wakeError) {
                            console.error('‚ùå Wake up failed:', wakeError);
                            debugLog('addShopping: Wake up failed', 'error', { error: wakeError.message });
                        }
                    }
                }

                // Check if it's a session error
                if (e.message && (e.message.includes('Session expired') || e.message.includes('Not authenticated'))) {
                    debugLog('addShopping: Session error detected', 'error');
                    if (retryCount < MAX_RETRIES) {
                        console.log('üîÑ Session error, refreshing and retrying...');
                        debugLog('addShopping: Attempting refresh after session error', 'warning');
                        try {
                            const { data: refreshData } = await supabase.auth.refreshSession();
                            if (refreshData && refreshData.session) {
                                state.user = refreshData.session.user;
                                state._lastSessionRefresh = Date.now();
                                state._sessionExpiresAt = refreshData.session.expires_at * 1000;
                                return await addShoppingToSupabase(item, retryCount + 1);
                            }
                        } catch (refreshError) {
                            console.error('‚ùå Refresh failed:', refreshError);
                            debugLog('addShopping: Refresh failed', 'error', { error: refreshError.message });
                        }
                    }
                    showToast('Session expired. Please refresh the page.');
                } else {
                    showToast('Failed to add item. Please try again.');
                }
                debugLog('addShopping: Operation failed, returning false', 'error');
                return false;
            }
        }

        async function updateShoppingInSupabase(id, updates) {
            if (!supabase || !state.household) return;
            try {
                await supabase.from('shopping').update(updates).eq('id', id);
            } catch (e) {
                console.error('Failed to update shopping:', e);
                showToast('Error: Failed to update shopping item. Please try again.');
            }
        }

        async function addTaskToSupabase(table, item, retryCount = 0) {
            const MAX_RETRIES = 2;

            // Wait if app is waking up
            if (state._isWakingUp) {
                console.log('‚è∏Ô∏è Waiting for app to wake up...');
                await new Promise(resolve => {
                    const checkInterval = setInterval(() => {
                        if (!state._isWakingUp) {
                            clearInterval(checkInterval);
                            resolve();
                        }
                    }, 100);
                });
            }

            if (!supabase) {
                console.error('‚ùå addTaskToSupabase failed: Supabase client is null');
                showToast('Database connection error. Please refresh the page.');
                return false;
            }

            if (!state.household) {
                console.error('‚ùå addTaskToSupabase failed: No household in state');
                showToast('No household selected. Please refresh and try again.');
                return false;
            }

            if (!state.user || !state.user.id) {
                console.error('‚ùå addTaskToSupabase failed: No user in state');
                showToast('User session lost. Please refresh and log in again.');
                return false;
            }

            console.log('üöÄ Adding task to Supabase (attempt ' + (retryCount + 1) + '/' + (MAX_RETRIES + 1) + '):', {
                table: table,
                name: item.name,
                notes: item.notes,
                assignee: item.assignee,
                household_id: state.household.id,
                user_id: state.user.id
            });

            try {
                // Ensure session is fresh before database operation
                await ensureFreshSession();

                console.log('‚è≥ Executing INSERT query...');

                var insertPromise = supabase.from(table).insert({
                    household_id: state.household.id,
                    name: item.name,
                    notes: item.notes,
                    assignee: item.assignee || null,
                    due_date: item.due || null,
                    completed: item.completed,
                    created_by: state.user.id
                }).select().single();

                var result = await withTimeout(
                    insertPromise,
                    30000,
                    'Database insert timed out after 30 seconds'
                );

                console.log('üì¶ INSERT completed, result:', result);

                if (result.error) {
                    console.error('‚ùå Supabase task insert error:', result.error);

                    // Check if it's an auth/permission error (42501, PGRST301, JWT)
                    const isAuthError = result.error.code === '42501' ||
                                       result.error.code === 'PGRST301' ||
                                       result.error.message.includes('policy') ||
                                       result.error.message.includes('JWT') ||
                                       result.error.message.includes('JWTExpired');

                    if (isAuthError && retryCount < MAX_RETRIES) {
                        console.log('üîÑ Auth error detected, forcing session refresh and retrying...');
                        // Force session refresh
                        const { data: refreshData } = await supabase.auth.refreshSession();
                        if (refreshData && refreshData.session) {
                            state.user = refreshData.session.user;
                            state._lastSessionRefresh = Date.now();
                            // Retry
                            return await addTaskToSupabase(table, item, retryCount + 1);
                        }
                    }

                    showToast('Failed to add task: ' + result.error.message);
                    return false;
                }

                if (result.data) {
                    item.id = result.data.id;
                    state._lastSuccessfulOperation = Date.now(); // Track successful operation
                    console.log('‚úÖ Task added successfully:', { table: table, id: result.data.id, name: item.name });
                    return true;
                }

                console.error('‚ùå Supabase task insert returned no error and no data');
                return false;
            } catch (e) {
                console.error('‚ùå Failed to add ' + table + ' (exception):', e);

                // Check if it's a timeout
                if (e.message && e.message.includes('timed out')) {
                    if (retryCount < MAX_RETRIES) {
                        console.log('‚è±Ô∏è Timeout detected, waking up app and retrying...');
                        try {
                            await wakeUpApp();
                            return await addTaskToSupabase(table, item, retryCount + 1);
                        } catch (wakeError) {
                            console.error('‚ùå Wake up failed:', wakeError);
                        }
                    }
                }

                // Check if it's a session error
                if (e.message && (e.message.includes('Session expired') || e.message.includes('Not authenticated'))) {
                    if (retryCount < MAX_RETRIES) {
                        console.log('üîÑ Session error, refreshing and retrying...');
                        try {
                            const { data: refreshData } = await supabase.auth.refreshSession();
                            if (refreshData && refreshData.session) {
                                state.user = refreshData.session.user;
                                state._lastSessionRefresh = Date.now();
                                return await addTaskToSupabase(table, item, retryCount + 1);
                            }
                        } catch (refreshError) {
                            console.error('‚ùå Refresh failed:', refreshError);
                        }
                    }
                    showToast('Session expired. Please refresh the page.');
                } else {
                    showToast('Failed to add task. Please try again.');
                }
                return false;
            }
        }

        async function updateTaskInSupabase(table, id, updates) {
            if (!supabase || !state.household) return;
            try {
                var dbUpdates = {};
                if ('completed' in updates) dbUpdates.completed = updates.completed;
                if ('name' in updates) dbUpdates.name = updates.name;
                if ('notes' in updates) dbUpdates.notes = updates.notes;
                if ('due' in updates) dbUpdates.due_date = updates.due;
                if ('assignee' in updates) dbUpdates.assignee = updates.assignee;
                await supabase.from(table).update(dbUpdates).eq('id', id);
            } catch (e) {
                console.error('Failed to update ' + table + ':', e);
                showToast('Error: Failed to update task. Please try again.');
            }
        }

        async function deleteShoppingFromSupabase(id) {
            if (!supabase || !state.household) return;
            try {
                await supabase.from('shopping').delete().eq('id', id);
            } catch (e) {
                console.error('Failed to delete shopping:', e);
                showToast('Error: Failed to delete item. Please try again.');
            }
        }

        async function deleteTaskFromSupabase(table, id) {
            if (!supabase || !state.household) return;
            try {
                await supabase.from(table).delete().eq('id', id);
            } catch (e) {
                console.error('Failed to delete ' + table + ':', e);
                showToast('Error: Failed to delete task. Please try again.');
            }
        }

        async function addQuickAddToSupabase(type, name) {
            if (!supabase || !state.household) return null;
            try {
                var sortOrder = state.quickAdd[type].length - 1;
                var result = await supabase.from('quick_add').insert({
                    household_id: state.household.id,
                    type: type,
                    name: name,
                    sort_order: sortOrder
                }).select().single();
                return result.data;
            } catch (e) {
                console.error('Failed to add quick_add:', e);
                showToast('Error: Failed to save quick-add item. Please try again.');
                return null;
            }
        }

        async function removeQuickAddFromSupabase(type, name) {
            if (!supabase || !state.household) return;
            try {
                await supabase.from('quick_add')
                    .delete()
                    .eq('household_id', state.household.id)
                    .eq('type', type)
                    .eq('name', name);
            } catch (e) {
                console.error('Failed to delete quick_add:', e);
                showToast('Error: Failed to remove quick-add item. Please try again.');
            }
        }

        // ========================================
        // REALTIME SUBSCRIPTIONS
        // ========================================
        let realtimeReconnectAttempts = 0;
        let realtimeReconnectTimer = null;

        async function setupRealtimeSubscriptions() {
            debugLog('setupRealtime: Starting setup', 'info');

            if (!supabase || !state.household) {
                debugLog('setupRealtime: Missing client or household', 'error');
                throw new Error('Missing supabase client or household');
            }

            // Clean up existing subscription first to prevent memory leaks
            if (state.realtimeChannel) {
                console.log('üîå Cleaning up old realtime subscription...');
                debugLog('setupRealtime: Cleaning up old subscription', 'info');
                try {
                    await supabase.removeChannel(state.realtimeChannel);
                    console.log('‚úÖ Old channel removed');
                    debugLog('setupRealtime: Old channel removed', 'success');
                } catch (e) {
                    console.warn('Error removing channel:', e);
                    debugLog('setupRealtime: Error removing channel', 'warning', { error: e.message });
                }
                state.realtimeChannel = null;

                // Add a small delay to ensure old channel is fully cleaned up
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            // Clear any pending reconnect timer
            if (realtimeReconnectTimer) {
                clearTimeout(realtimeReconnectTimer);
                realtimeReconnectTimer = null;
            }

            var householdId = state.household.id;
            console.log('üì° Setting up realtime subscriptions for household:', householdId);
            debugLog('setupRealtime: Creating new channel', 'info', { household: householdId });

            // Return a Promise that resolves when connection succeeds or rejects on failure
            return new Promise((resolve, reject) => {
                // Set a timeout to detect stuck connections
                const connectionTimeout = setTimeout(() => {
                    console.error('‚è±Ô∏è Realtime connection timeout after 15 seconds');
                    debugLog('setupRealtime: Connection timeout', 'error');
                    reject(new Error('Connection timeout'));
                }, 15000);

                state.realtimeChannel = supabase.channel('household-changes-' + householdId)
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'shopping', filter: 'household_id=eq.' + householdId }, handleShoppingChange)
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'tasks', filter: 'household_id=eq.' + householdId }, handleTasksChange)
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'clifford', filter: 'household_id=eq.' + householdId }, handleCliffordChange)
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'household_members', filter: 'household_id=eq.' + householdId }, handleMembersChange)
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'quick_add', filter: 'household_id=eq.' + householdId }, handleQuickAddChange)
                    .subscribe(function(status, error) {
                        console.log('üîî Realtime status:', status, error || '');
                        debugLog('setupRealtime: Status change', 'info', { status: status, error: error?.message });

                        if (status === 'SUBSCRIBED') {
                            clearTimeout(connectionTimeout);
                            console.log('‚úÖ Realtime subscriptions active');
                            debugLog('setupRealtime: Subscribed successfully', 'success');
                            // Reset reconnect attempts on successful connection
                            realtimeReconnectAttempts = 0;
                            showSyncStatus('online', 'Online');
                            resolve();  // Resolve the promise on success
                        } else if (status === 'CLOSED') {
                            clearTimeout(connectionTimeout);
                            console.log('‚ùå Realtime subscription closed - attempting reconnect...');
                            debugLog('setupRealtime: Subscription closed', 'error');
                            reject(new Error('Subscription closed'));
                            attemptRealtimeReconnect();
                        } else if (status === 'CHANNEL_ERROR') {
                            clearTimeout(connectionTimeout);
                            console.error('‚ùå Realtime subscription error - attempting reconnect...', error);
                            debugLog('setupRealtime: Channel error', 'error', { error: error?.message });
                            reject(error || new Error('Channel error'));
                            attemptRealtimeReconnect();
                        } else if (status === 'TIMED_OUT') {
                            clearTimeout(connectionTimeout);
                            console.error('‚è±Ô∏è Realtime subscription timed out - attempting reconnect...');
                            debugLog('setupRealtime: Subscription timed out', 'error');
                            reject(new Error('Subscription timed out'));
                            attemptRealtimeReconnect();
                        }
                    });
            });
        }

        function attemptRealtimeReconnect() {
            // Don't reconnect if user is not logged in or no household
            if (!supabase || !state.household || !state.user) {
                console.log('‚è∏Ô∏è Skipping reconnect - not authenticated');
                return;
            }

            // Don't reconnect if page is hidden
            if (document.hidden) {
                console.log('‚è∏Ô∏è Skipping reconnect - page is hidden');
                return;
            }

            // Exponential backoff: 1s, 2s, 4s, 8s, 16s, max 30s
            realtimeReconnectAttempts++;
            const delay = Math.min(1000 * Math.pow(2, realtimeReconnectAttempts - 1), 30000);

            console.log(`üîÑ Will attempt reconnect #${realtimeReconnectAttempts} in ${delay}ms...`);
            showSyncStatus('offline', 'Reconnecting...');

            // Clear any existing timer
            if (realtimeReconnectTimer) {
                clearTimeout(realtimeReconnectTimer);
            }

            realtimeReconnectTimer = setTimeout(async function() {
                console.log(`üîÑ Reconnecting realtime (attempt ${realtimeReconnectAttempts})...`);

                try {
                    // CRITICAL: Refresh the session BEFORE reconnecting realtime
                    // Otherwise the JWT token might be expired and database operations will fail
                    console.log('üîÑ Refreshing session before reconnecting...');
                    await ensureFreshSession();
                    console.log('‚úÖ Session refreshed, now reconnecting realtime...');

                    // Now reconnect the realtime channel with fresh auth - AWAIT the result!
                    await setupRealtimeSubscriptions();
                    console.log('‚úÖ Realtime reconnection succeeded');
                } catch (error) {
                    console.error('‚ùå Reconnection failed:', error);
                    showSyncStatus('offline', 'Reconnection failed - retrying...');

                    // Retry with exponential backoff (up to 10 attempts)
                    if (realtimeReconnectAttempts < 10) {
                        attemptRealtimeReconnect();
                    } else {
                        console.error('‚ùå Max reconnect attempts reached');
                        showSyncStatus('offline', 'Connection failed - please refresh page');
                    }
                }
            }, delay);
        }

        async function checkRealtimeHealth() {
            if (!state.realtimeChannel || !supabase) return true;

            try {
                // Get channel state
                const channelState = state.realtimeChannel.state;
                console.log('ü©∫ Realtime health check - state:', channelState);

                // If channel is not in joined state, reconnect
                if (channelState !== 'joined') {
                    console.warn('‚ö†Ô∏è Realtime channel not healthy, refreshing session and reconnecting...');

                    try {
                        // Refresh session first before reconnecting
                        await ensureFreshSession();
                        await setupRealtimeSubscriptions();
                    } catch (error) {
                        console.error('‚ùå Failed during health check recovery:', error);
                    }

                    return false;
                }

                return true;
            } catch (e) {
                console.error('‚ùå Error checking realtime health:', e);

                try {
                    // Refresh session first before reconnecting
                    await ensureFreshSession();
                    await setupRealtimeSubscriptions();
                } catch (error) {
                    console.error('‚ùå Failed after health check error:', error);
                }

                return false;
            }
        }

        function handleShoppingChange(payload) {
            if (payload.eventType === 'INSERT') {
                var exists = state.shopping.find(function(i) { return i.id === payload.new.id; });
                if (!exists) {
                    state.shopping.unshift(mapShoppingItem(payload.new));
                    renderShopping();
                    renderDashboard();
                }
            } else if (payload.eventType === 'UPDATE') {
                var item = state.shopping.find(function(i) { return i.id === payload.new.id; });
                if (item) {
                    Object.assign(item, mapShoppingItem(payload.new));
                    renderShopping();
                    renderDashboard();
                }
            } else if (payload.eventType === 'DELETE') {
                state.shopping = state.shopping.filter(function(i) { return i.id !== payload.old.id; });
                renderShopping();
                renderDashboard();
            }
            saveData();
        }

        function handleTasksChange(payload) {
            handleGenericChange('tasks', payload);
        }

        function handleCliffordChange(payload) {
            handleGenericChange('clifford', payload);
        }

        function handleGenericChange(type, payload) {
            var list = state[type];
            if (payload.eventType === 'INSERT') {
                var exists = list.find(function(i) { return i.id === payload.new.id; });
                if (!exists) {
                    list.unshift(mapTaskItem(payload.new));
                }
            } else if (payload.eventType === 'UPDATE') {
                var item = list.find(function(i) { return i.id === payload.new.id; });
                if (item) {
                    Object.assign(item, mapTaskItem(payload.new));
                }
            } else if (payload.eventType === 'DELETE') {
                state[type] = list.filter(function(i) { return i.id !== payload.old.id; });
            }
            if (type === 'tasks') renderTasks();
            else renderClifford();
            renderDashboard();
            saveData();
        }

        function handleMembersChange(payload) {
            loadFromSupabase().then(function() {
                renderMembers();
                renderAll();
            });
        }

        function handleQuickAddChange(payload) {
            if (payload.eventType === 'INSERT') {
                var type = payload.new.type;
                var name = payload.new.name;
                if (state.quickAdd[type] && !state.quickAdd[type].includes(name)) {
                    state.quickAdd[type].push(name);
                    renderQuickButtons(type);
                    saveData();
                }
            } else if (payload.eventType === 'DELETE') {
                var type = payload.old.type;
                var name = payload.old.name;
                if (state.quickAdd[type]) {
                    state.quickAdd[type] = state.quickAdd[type].filter(function(item) { return item !== name; });
                    renderQuickButtons(type);
                    saveData();
                }
            } else if (payload.eventType === 'UPDATE') {
                // Reload all quick_add items to maintain proper order
                loadFromSupabase();
            }
        }

        // ========================================
        // UI SCREEN MANAGEMENT
        // ========================================
        // Splash screen management
        let splashMinTimeElapsed = false;
        let appReady = false;
        let splashHidden = false;

        // Set minimum splash time of 3 seconds
        setTimeout(function() {
            splashMinTimeElapsed = true;
            hideSplashIfReady();
        }, 3000);

        // Failsafe: Always hide splash after 5 seconds, even if app isn't ready
        // This prevents the splash screen from blocking the UI if there's an error
        setTimeout(function() {
            if (!splashHidden) {
                console.log('‚è±Ô∏è Splash screen failsafe timeout - forcing hide');
                debugLog('Splash: Forcing hide after 5s timeout', 'warning');
                var splash = document.getElementById('splash-screen');
                if (splash) {
                    splash.classList.add('fade-out');
                    setTimeout(function() {
                        splash.style.display = 'none';
                    }, 500);
                    splashHidden = true;
                }
            }
        }, 5000);

        function hideSplashIfReady() {
            if ((splashMinTimeElapsed && appReady) && !splashHidden) {
                var splash = document.getElementById('splash-screen');
                splash.classList.add('fade-out');
                // Remove from DOM after transition
                setTimeout(function() {
                    splash.style.display = 'none';
                }, 500);
                splashHidden = true;
            }
        }

        function showAuthScreen() {
            appReady = true;
            hideSplashIfReady();
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('signup-form').classList.add('hidden');
            document.getElementById('household-setup').classList.add('hidden');
            document.getElementById('auth-switch').classList.remove('hidden');
            hideAuthError();
        }

        function showHouseholdSetup() {
            appReady = true;
            hideSplashIfReady();
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('signup-form').classList.add('hidden');
            document.getElementById('household-setup').classList.remove('hidden');
            document.getElementById('household-choice').classList.remove('hidden');
            document.getElementById('create-household-form').classList.add('hidden');
            document.getElementById('join-household-form').classList.add('hidden');
            document.getElementById('household-created').classList.add('hidden');
            document.getElementById('auth-switch').classList.add('hidden');
            document.getElementById('auth-subtitle').textContent = 'Set up your household';
        }

        function showMainApp() {
            appReady = true;
            hideSplashIfReady();
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            if (state.household) {
                document.getElementById('settings-invite-code').textContent = state.household.invite_code || '------';
            }
        }

        // ========================================
        // LANGUAGE & THEME
        // ========================================
        function applyLanguage() {
            document.querySelectorAll('[data-i18n]').forEach(function(el) {
                var key = el.getAttribute('data-i18n');
                el.textContent = t(key);
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(function(el) {
                var key = el.getAttribute('data-i18n-placeholder');
                el.placeholder = t(key);
            });
            document.documentElement.lang = state.language;
        }

        function applyTheme() {
            document.body.setAttribute('data-theme', state.theme);
            var metaTheme = document.querySelector('meta[name="theme-color"]');
            if (metaTheme) {
                metaTheme.content = state.theme === 'light' ? '#f5f5f5' : '#000000';
            }
        }

        function setLanguage(lang) {
            state.language = lang;
            localStorage.setItem('hoi-language', lang);
            applyLanguage();
            renderAll();
        }

        function setTheme(theme) {
            state.theme = theme;
            localStorage.setItem('hoi-theme', theme);
            applyTheme();
        }

        // ========================================
        // MOCK DATA INITIALIZATION
        // ========================================
        function initMockData() {
            state.shopping = [
                { id: generateId(), name: 'Full cream milk', notes: 'Get 2 litres red label', completed: false },
                { id: generateId(), name: 'Whole wheat bread', notes: 'Albany brand', completed: false },
                { id: generateId(), name: 'Free range eggs', notes: 'Large size', completed: false },
                { id: generateId(), name: 'Dish soap', notes: '', completed: false },
                { id: generateId(), name: 'Fresh vegetables', notes: '', completed: true }
            ];

            state.tasks = [
                { id: generateId(), name: 'Feed the dogs', assignee: 'sarah', due: getRelativeDate(0), notes: 'Morning and evening', completed: false },
                { id: generateId(), name: 'Water the garden', assignee: 'john', due: getRelativeDate(2), notes: 'Early morning', completed: false },
                { id: generateId(), name: 'Weekly grocery shopping', assignee: 'mary', due: getRelativeDate(1), notes: 'Check list first', completed: false },
                { id: generateId(), name: 'Clean the pool', assignee: 'tom', due: getRelativeDate(3), notes: '', completed: false },
                { id: generateId(), name: 'Take out trash', assignee: 'john', due: getRelativeDate(0), notes: '', completed: true }
            ];

            state.clifford = [
                { id: generateId(), name: 'Vaccines due', assignee: 'sarah', due: getRelativeDate(5), notes: '6-month checkup', completed: false },
                { id: generateId(), name: 'Buy nappies', assignee: 'mary', due: getRelativeDate(1), notes: 'Size 4 Pampers', completed: false },
                { id: generateId(), name: 'Doctor appointment', assignee: 'john', due: getRelativeDate(7), notes: 'Pediatrician - 10am', completed: false },
                { id: generateId(), name: 'Buy formula', assignee: 'sarah', due: getRelativeDate(3), notes: '', completed: true }
            ];
        }

        // ========================================
        // NAVIGATION FUNCTIONS
        // ========================================
        function navigateToPage(pageName) {
            var navBtns = document.querySelectorAll('.nav-btn');
            var pages = document.querySelectorAll('.page');

            navBtns.forEach(function(b) {
                b.classList.remove('active');
                b.removeAttribute('aria-current');
                if (b.dataset.page === pageName) {
                    b.classList.add('active');
                    b.setAttribute('aria-current', 'page');
                }
            });

            pages.forEach(function(p) { p.classList.remove('active'); });
            document.getElementById('page-' + pageName).classList.add('active');

            // Refresh dashboard when navigating to it
            if (pageName === 'dashboard') {
                renderDashboard();
            }

            window.scrollTo(0, 0);
        }

        // ========================================
        // RENDER FUNCTIONS
        // ========================================
        function renderDashboard() {
            var container = document.getElementById('dashboard-stats');
            var shoppingActive = state.shopping.filter(function(i) { return !i.completed; }).length;
            var tasksActive = state.tasks.filter(function(t) { return !t.completed; }).length;
            var cliffordActive = state.clifford.filter(function(t) { return !t.completed; }).length;

            container.innerHTML =
                '<div class="stat-card">' +
                    '<button class="stat-icon-btn" onclick="navigateToPage(\'shopping\')" aria-label="' + t('shopping') + '">' +
                        'üõí' +
                    '</button>' +
                    '<div class="stat-title">' + t('shopping') + '</div>' +
                    '<div class="stat-value">' + shoppingActive + '</div>' +
                    '<div class="stat-label">' + t('toBuy') + '</div>' +
                '</div>' +
                '<div class="stat-card">' +
                    '<button class="stat-icon-btn" onclick="navigateToPage(\'tasks\')" aria-label="' + t('tasks') + '">' +
                        '‚úì' +
                    '</button>' +
                    '<div class="stat-title">' + t('tasks') + '</div>' +
                    '<div class="stat-value">' + tasksActive + '</div>' +
                    '<div class="stat-label">' + t('active') + '</div>' +
                '</div>' +
                '<div class="stat-card">' +
                    '<button class="stat-icon-btn" onclick="navigateToPage(\'clifford\')" aria-label="' + t('clifford') + '">' +
                        'üë∂' +
                    '</button>' +
                    '<div class="stat-title">' + t('clifford') + '</div>' +
                    '<div class="stat-value">' + cliffordActive + '</div>' +
                    '<div class="stat-label">' + t('active') + '</div>' +
                '</div>';

            renderUpcomingTasks();
            renderUpcomingClifford();
        }

        function renderUpcomingItem(item, type) {
            var member = item.assignee ? state.members.find(function(m) { return m.id === item.assignee; }) : null;
            var memberName = member ? member.name : '';
            var dueText = formatDate(item.due);
            var dueClass = getDateClass(item.due);
            var safeName = escapeHtml(item.name);

            return '<div class="upcoming-item">' +
                '<div class="upcoming-icon">' + (type === 'tasks' ? '‚úì' : 'üë∂') + '</div>' +
                '<div class="upcoming-content">' +
                    '<div class="upcoming-name">' + safeName + '</div>' +
                    '<div class="upcoming-meta">' +
                        (memberName ? '<span>üë§ ' + escapeHtml(memberName) + '</span>' : '') +
                        (dueText ? '<span class="upcoming-due ' + dueClass + '">üìÖ ' + dueText + '</span>' : '') +
                    '</div>' +
                '</div>' +
            '</div>';
        }

        function renderUpcomingTasks() {
            var container = document.getElementById('dashboard-upcoming-tasks');
            var upcoming = state.tasks
                .filter(function(t) { return !t.completed; })
                .sort(function(a, b) {
                    if (!a.due && !b.due) return 0;
                    if (!a.due) return 1;
                    if (!b.due) return -1;
                    return new Date(a.due) - new Date(b.due);
                })
                .slice(0, 5);

            if (upcoming.length === 0) {
                container.innerHTML = '';
                return;
            }

            var html = '<h3>‚úì ' + t('upcomingTasks') + '</h3>';
            upcoming.forEach(function(item) {
                html += renderUpcomingItem(item, 'tasks');
            });
            container.innerHTML = html;
        }

        function renderUpcomingClifford() {
            var container = document.getElementById('dashboard-upcoming-clifford');
            var upcoming = state.clifford
                .filter(function(t) { return !t.completed; })
                .sort(function(a, b) {
                    if (!a.due && !b.due) return 0;
                    if (!a.due) return 1;
                    if (!b.due) return -1;
                    return new Date(a.due) - new Date(b.due);
                })
                .slice(0, 5);

            if (upcoming.length === 0) {
                container.innerHTML = '';
                return;
            }

            var html = '<h3>üë∂ ' + t('upcomingClifford') + '</h3>';
            upcoming.forEach(function(item) {
                html += renderUpcomingItem(item, 'clifford');
            });
            container.innerHTML = html;
        }

        function renderShoppingItem(item) {
            var safeName = escapeHtml(item.name);
            var safeNotes = escapeHtml(item.notes);

            return '<div class="list-item ' + (item.completed ? 'completed' : '') + '" data-id="' + item.id + '">' +
                '<button class="item-checkbox ' + (item.completed ? 'checked' : '') + '" ' +
                        'onclick="toggleShopping(\'' + item.id + '\')" ' +
                        'aria-label="' + (item.completed ? t('markedNotPurchased') : t('markedPurchased')) + '">' +
                    (item.completed ? '‚úì' : '') +
                '</button>' +
                '<div class="item-content">' +
                    '<div class="item-name">' + safeName + '</div>' +
                    (safeNotes ? '<div class="item-notes">' + safeNotes + '</div>' : '') +
                '</div>' +
                '<div class="item-actions">' +
                    '<button class="item-edit" ' +
                            'onclick="openEditModal(\'shopping\', \'' + item.id + '\')" ' +
                            'aria-label="Edit item">' +
                        '‚úé' +
                    '</button>' +
                    '<button class="item-delete" ' +
                            'onclick="deleteShopping(\'' + item.id + '\')" ' +
                            'aria-label="Delete item">' +
                        '‚úï' +
                    '</button>' +
                '</div>' +
            '</div>';
        }

        function renderShopping() {
            var container = document.getElementById('shopping-list');
            var active = state.shopping.filter(function(i) { return !i.completed; });
            var completed = state.shopping.filter(function(i) { return i.completed; });

            var html = '';

            if (active.length > 0) {
                html += '<div class="list-section"><h3>' + t('toBuy') + ' (' + active.length + ')</h3>';
                active.forEach(function(item) { html += renderShoppingItem(item); });
                html += '</div>';
            }

            if (completed.length > 0) {
                var isExpanded = !state.collapsedSections.shopping;
                html += '<div class="list-section">';
                html += '<button class="collapsible-header ' + (isExpanded ? 'expanded' : '') + '" ' +
                        'onclick="toggleCollapsedSection(\'shopping\')" ' +
                        'aria-expanded="' + isExpanded + '" aria-controls="shopping-completed">' +
                    '<h3>' + t('purchased') + ' (' + completed.length + ')</h3>' +
                    '<span class="collapsible-toggle">‚ñº</span>' +
                '</button>';
                html += '<div id="shopping-completed" class="collapsible-content ' + (isExpanded ? 'expanded' : '') + '">';
                completed.forEach(function(item) { html += renderShoppingItem(item); });
                html += '</div></div>';
            }

            if (state.shopping.length === 0) {
                html = '<div class="empty-state"><div class="icon">üõí</div><p>' + t('noShoppingItems') + '</p></div>';
            }

            container.innerHTML = html;
            renderQuickButtons('shopping');
        }

        function renderTaskItem(item, type) {
            var member = item.assignee ? state.members.find(function(m) { return m.id === item.assignee; }) : null;
            var memberName = member ? member.name : '';
            var dueText = formatDate(item.due);
            var dueClass = getDateClass(item.due);
            var safeName = escapeHtml(item.name);
            var safeNotes = escapeHtml(item.notes);

            return '<div class="list-item ' + (item.completed ? 'completed' : '') + '" data-id="' + item.id + '">' +
                '<button class="item-checkbox ' + (item.completed ? 'checked' : '') + '" ' +
                        'onclick="toggleTask(\'' + item.id + '\', \'' + type + '\')" ' +
                        'aria-label="' + (item.completed ? t('taskIncomplete') : t('taskCompleted')) + '">' +
                    (item.completed ? '‚úì' : '') +
                '</button>' +
                '<div class="item-content">' +
                    '<div class="item-name">' + safeName + '</div>' +
                    '<div class="item-meta">' +
                        (memberName ? '<span class="badge badge-member">üë§ ' + escapeHtml(memberName) + '</span>' : '') +
                        (dueText ? '<span class="badge badge-due ' + dueClass + '">üìÖ ' + dueText + '</span>' : '') +
                    '</div>' +
                    (safeNotes ? '<div class="item-notes">' + safeNotes + '</div>' : '') +
                '</div>' +
                '<div class="item-actions">' +
                    '<button class="item-edit" ' +
                            'onclick="openEditModal(\'' + type + '\', \'' + item.id + '\')" ' +
                            'aria-label="Edit task">' +
                        '‚úé' +
                    '</button>' +
                    '<button class="item-delete" ' +
                            'onclick="deleteTask(\'' + item.id + '\', \'' + type + '\')" ' +
                            'aria-label="Delete task">' +
                        '‚úï' +
                    '</button>' +
                '</div>' +
            '</div>';
        }

        function sortTasks(tasks) {
            return tasks.slice().sort(function(a, b) {
                if (a.completed !== b.completed) return a.completed ? 1 : -1;
                if (!a.due && !b.due) return 0;
                if (!a.due) return 1;
                if (!b.due) return -1;
                return new Date(a.due) - new Date(b.due);
            });
        }

        function renderTasks() {
            var container = document.getElementById('tasks-list');
            var sorted = sortTasks(state.tasks);
            var active = sorted.filter(function(t) { return !t.completed; });
            var completed = sorted.filter(function(t) { return t.completed; });

            var html = '';

            if (active.length > 0) {
                html += '<div class="list-section"><h3>' + t('activeTasks') + ' (' + active.length + ')</h3>';
                active.forEach(function(item) { html += renderTaskItem(item, 'tasks'); });
                html += '</div>';
            }

            if (completed.length > 0) {
                var isExpanded = !state.collapsedSections.tasks;
                html += '<div class="list-section">';
                html += '<button class="collapsible-header ' + (isExpanded ? 'expanded' : '') + '" ' +
                        'onclick="toggleCollapsedSection(\'tasks\')" ' +
                        'aria-expanded="' + isExpanded + '" aria-controls="tasks-completed">' +
                    '<h3>' + t('completed') + ' (' + completed.length + ')</h3>' +
                    '<span class="collapsible-toggle">‚ñº</span>' +
                '</button>';
                html += '<div id="tasks-completed" class="collapsible-content ' + (isExpanded ? 'expanded' : '') + '">';
                completed.forEach(function(item) { html += renderTaskItem(item, 'tasks'); });
                html += '</div></div>';
            }

            if (state.tasks.length === 0) {
                html = '<div class="empty-state"><div class="icon">‚úì</div><p>' + t('noTasks') + '</p></div>';
            }

            container.innerHTML = html;
            renderQuickButtons('tasks');
        }

        function renderClifford() {
            var container = document.getElementById('clifford-list');
            var sorted = sortTasks(state.clifford);
            var active = sorted.filter(function(t) { return !t.completed; });
            var completed = sorted.filter(function(t) { return t.completed; });

            var html = '';

            if (active.length > 0) {
                html += '<div class="list-section"><h3>' + t('activeTasks') + ' (' + active.length + ')</h3>';
                active.forEach(function(item) { html += renderTaskItem(item, 'clifford'); });
                html += '</div>';
            }

            if (completed.length > 0) {
                var isExpanded = !state.collapsedSections.clifford;
                html += '<div class="list-section">';
                html += '<button class="collapsible-header ' + (isExpanded ? 'expanded' : '') + '" ' +
                        'onclick="toggleCollapsedSection(\'clifford\')" ' +
                        'aria-expanded="' + isExpanded + '" aria-controls="clifford-completed">' +
                    '<h3>' + t('completed') + ' (' + completed.length + ')</h3>' +
                    '<span class="collapsible-toggle">‚ñº</span>' +
                '</button>';
                html += '<div id="clifford-completed" class="collapsible-content ' + (isExpanded ? 'expanded' : '') + '">';
                completed.forEach(function(item) { html += renderTaskItem(item, 'clifford'); });
                html += '</div></div>';
            }

            if (state.clifford.length === 0) {
                html = '<div class="empty-state"><div class="icon">üë∂</div><p>' + t('noCliffordTasks') + '</p></div>';
            }

            container.innerHTML = html;
            renderQuickButtons('clifford');
        }

        function renderMembers() {
            var container = document.getElementById('members-grid');

            if (state.members.length === 0) {
                container.innerHTML = '<p style="color: var(--text-light); grid-column: 1/-1; text-align: center;">No household members yet</p>';
                return;
            }

            container.innerHTML = state.members.map(function(member, index) {
                var colors = ['john', 'sarah', 'mary', 'tom'];
                var colorClass = colors[index % colors.length];
                var isCurrentUser = member.user_id === state.user.id;

                return '<div class="member-card">' +
                    '<div class="member-avatar ' + colorClass + '">' + escapeHtml(member.initials) + '</div>' +
                    '<div class="member-name">' + escapeHtml(member.name) + '</div>' +
                    (!isCurrentUser ? '<button class="member-remove" onclick="removeUserFromHousehold(\'' + member.id + '\')" aria-label="Remove member">‚úï</button>' : '') +
                '</div>';
            }).join('');

            // Update assignee dropdowns
            updateAssigneeDropdowns();
        }

        function updateAssigneeDropdowns() {
            var dropdowns = ['task-assignee', 'clifford-assignee'];
            dropdowns.forEach(function(id) {
                var select = document.getElementById(id);
                if (select && state.members.length > 0) {
                    select.innerHTML = state.members.map(function(member) {
                        return '<option value="' + member.id + '">' + escapeHtml(member.name) + '</option>';
                    }).join('');
                }
            });
        }

        function renderQuickButtons(type) {
            var container = document.getElementById(type + '-quick-btns');
            container.innerHTML = state.quickAdd[type].map(function(item, index) {
                var safeItem = escapeHtml(item);
                return '<button class="quick-btn" data-type="' + type + '" data-index="' + index + '">' + safeItem + '</button>';
            }).join('');

            // Use event delegation for safety (no inline JS)
            container.querySelectorAll('.quick-btn').forEach(function(btn) {
                btn.addEventListener('click', async function() {
                    // Disable button to prevent double-clicks
                    if (btn.disabled) return;

                    var originalText = btn.textContent;
                    btn.disabled = true;
                    btn.textContent = '‚è≥ ' + originalText;
                    btn.classList.add('loading');

                    try {
                        var btnType = btn.getAttribute('data-type');
                        var btnIndex = parseInt(btn.getAttribute('data-index'), 10);
                        var itemText = state.quickAdd[btnType][btnIndex];

                        if (itemText) {
                            await quickAdd(btnType, itemText);
                        }
                    } catch (e) {
                        console.error('‚ùå Quick Add button error:', e);
                        showToast('An unexpected error occurred. Please try again.');
                    } finally {
                        // Always re-enable button, even if error occurs
                        btn.disabled = false;
                        btn.textContent = originalText;
                        btn.classList.remove('loading');
                    }
                });
            });
        }

        function renderManageList() {
            var container = document.getElementById('manage-list');
            var items = state.quickAdd[state.currentManageType];

            container.innerHTML = items.map(function(item, index) {
                var safeItem = escapeHtml(item);
                return '<div class="manage-item">' +
                    '<span>' + safeItem + '</span>' +
                    '<button class="remove-item-btn" data-index="' + index + '" aria-label="Remove item">‚úï</button>' +
                '</div>';
            }).join('');

            // Use event delegation for safety
            container.querySelectorAll('.remove-item-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var idx = parseInt(btn.getAttribute('data-index'), 10);
                    removeStandardItem(idx);
                });
            });
        }

        function renderAll() {
            renderDashboard();
            renderShopping();
            renderTasks();
            renderClifford();
            renderMembers();
        }

        // ========================================
        // ACTION HANDLERS
        // ========================================
        function toggleShopping(id) {
            var item = state.shopping.find(function(i) { return i.id === id; });
            if (item) {
                item.completed = !item.completed;
                saveData();
                updateShoppingInSupabase(id, { completed: item.completed });
                renderShopping();
                renderDashboard();
                showToast(item.completed ? t('markedPurchased') : t('markedNotPurchased'));
            }
        }

        function toggleTask(id, type) {
            var list = state[type];
            var item = list.find(function(t) { return t.id === id; });
            if (item) {
                item.completed = !item.completed;
                saveData();
                updateTaskInSupabase(type, id, { completed: item.completed });
                if (type === 'tasks') renderTasks();
                else renderClifford();
                renderDashboard();
                showToast(item.completed ? t('taskCompleted') : t('taskIncomplete'));
            }
        }

        function deleteShopping(id) {
            var item = state.shopping.find(function(i) { return i.id === id; });
            if (item) {
                var itemName = item.name;
                state.shopping = state.shopping.filter(function(i) { return i.id !== id; });
                saveData();
                deleteShoppingFromSupabase(id);
                renderShopping();
                renderDashboard();
                showToast('Deleted: ' + itemName);
            }
        }

        function deleteTask(id, type) {
            var list = state[type];
            var item = list.find(function(t) { return t.id === id; });
            if (item) {
                var itemName = item.name;
                state[type] = list.filter(function(t) { return t.id !== id; });
                saveData();
                deleteTaskFromSupabase(type, id);
                if (type === 'tasks') renderTasks();
                else renderClifford();
                renderDashboard();
                showToast('Deleted: ' + itemName);
            }
        }

        async function removeUserFromHousehold(memberId) {
            var member = state.members.find(function(m) { return m.id === memberId; });
            if (!member) return;

            if (!confirm('Remove ' + member.name + ' from the household? Any tasks assigned to them will become unassigned.')) {
                return;
            }

            try {
                // Unassign all tasks from this member
                await unassignMemberTasks(memberId);

                // Remove member from database
                if (supabase) {
                    await supabase.from('household_members').delete().eq('id', memberId);
                }

                // Update local state
                state.members = state.members.filter(function(m) { return m.id !== memberId; });
                saveData();
                renderMembers();
                renderAll(); // Re-render all lists to update assignee displays
                showToast(member.name + ' removed from household');
            } catch (e) {
                console.error('Failed to remove member:', e);
                showToast('Error: Failed to remove member. Please try again.');
            }
        }

        async function unassignMemberTasks(memberId) {
            if (!supabase || !state.household) return;

            try {
                // Unassign tasks
                await supabase.from('tasks')
                    .update({ assignee: null })
                    .eq('household_id', state.household.id)
                    .eq('assignee', memberId);

                // Unassign clifford tasks
                await supabase.from('clifford')
                    .update({ assignee: null })
                    .eq('household_id', state.household.id)
                    .eq('assignee', memberId);

                // Update local state
                state.tasks.forEach(function(task) {
                    if (task.assignee === memberId) task.assignee = null;
                });
                state.clifford.forEach(function(task) {
                    if (task.assignee === memberId) task.assignee = null;
                });
            } catch (e) {
                console.error('Failed to unassign tasks:', e);
                throw e;
            }
        }

        function openEditModal(type, id) {
            var item;
            if (type === 'shopping') {
                item = state.shopping.find(function(i) { return i.id === id; });
            } else {
                item = state[type].find(function(i) { return i.id === id; });
            }

            if (!item) return;

            state.editingItem = { type: type, item: JSON.parse(JSON.stringify(item)) };

            // Populate form
            document.getElementById('edit-name').value = item.name;
            document.getElementById('edit-notes').value = item.notes || '';

            // Show/hide fields based on type
            if (type === 'shopping') {
                document.getElementById('edit-assignee-group').style.display = 'none';
                document.getElementById('edit-due-group').style.display = 'none';
                document.getElementById('modal-edit-title').textContent = 'Edit Shopping Item';
            } else {
                document.getElementById('edit-assignee-group').style.display = 'block';
                document.getElementById('edit-due-group').style.display = 'block';
                document.getElementById('modal-edit-title').textContent = type === 'tasks' ? 'Edit Task' : 'Edit Clifford Task';

                // Populate assignee dropdown
                var assigneeSelect = document.getElementById('edit-assignee');
                assigneeSelect.innerHTML = '<option value="">Unassigned</option>';
                state.members.forEach(function(member) {
                    var selected = item.assignee === member.id ? ' selected' : '';
                    assigneeSelect.innerHTML += '<option value="' + member.id + '"' + selected + '>' + escapeHtml(member.name) + '</option>';
                });

                // Set due date
                document.getElementById('edit-due').value = item.due || '';
            }

            // Open modal
            document.getElementById('modal-edit').classList.add('open');
            document.getElementById('modal-edit').setAttribute('aria-hidden', 'false');
        }

        function saveEditedItem() {
            if (!state.editingItem) return;

            var type = state.editingItem.type;
            var id = state.editingItem.item.id;
            var name = document.getElementById('edit-name').value.trim();

            if (!name) {
                showToast('Error: Name is required');
                return;
            }

            var updates = {
                name: name,
                notes: document.getElementById('edit-notes').value.trim()
            };

            if (type !== 'shopping') {
                updates.assignee = document.getElementById('edit-assignee').value || null;
                updates.due = document.getElementById('edit-due').value || '';
            }

            // Update local state
            var item;
            if (type === 'shopping') {
                item = state.shopping.find(function(i) { return i.id === id; });
            } else {
                item = state[type].find(function(i) { return i.id === id; });
            }

            if (item) {
                Object.assign(item, updates);
                saveData();

                // Update in Supabase
                if (type === 'shopping') {
                    updateShoppingInSupabase(id, updates);
                    renderShopping();
                } else {
                    updateTaskInSupabase(type, id, updates);
                    if (type === 'tasks') renderTasks();
                    else renderClifford();
                }
                renderDashboard();
                showToast('Updated: ' + name);
            }

            // Close modal
            closeModal('modal-edit');
            state.editingItem = null;
        }

        function toggleCollapsedSection(type) {
            state.collapsedSections[type] = !state.collapsedSections[type];
            if (type === 'shopping') renderShopping();
            else if (type === 'tasks') renderTasks();
            else if (type === 'clifford') renderClifford();
        }

        async function quickAdd(type, itemText) {
            console.log('üöÄ Quick Add triggered:', {
                type: type,
                itemText: itemText,
                householdId: state.household ? state.household.id : 'MISSING',
                userId: state.user ? state.user.id : 'MISSING'
            });

            if (!state.household) {
                console.error('‚ùå Quick Add failed: No household selected');
                showToast('Please select a household first');
                return;
            }

            if (!state.user) {
                console.error('‚ùå Quick Add failed: No user logged in');
                showToast('Please log in first');
                return;
            }

            var name = itemText.replace(/^[\p{Emoji}\p{Emoji_Presentation}\p{Extended_Pictographic}]+\s*/gu, '') || itemText;

            if (type === 'shopping') {
                var item = {
                    id: generateId(),
                    name: name,
                    notes: '',
                    completed: false
                };

                console.log('üöÄ Quick Add: Creating shopping item:', item);

                // Add to Supabase - real-time subscription will update local state
                var success = await addShoppingToSupabase(item);

                if (success) {
                    showToast(t('itemAdded', { name: name }));
                    console.log('‚úÖ Quick Add: Shopping item added, real-time will sync');
                    // Note: Don't add to local state here - real-time subscription handles it
                } else {
                    console.error('‚ùå Quick Add: Shopping item not added due to database error');
                }
            } else {
                var list = type === 'tasks' ? state.tasks : state.clifford;
                var defaultAssignee = state.members.length > 0 ? state.members[0].id : null;
                var taskItem = {
                    id: generateId(),
                    name: name,
                    assignee: defaultAssignee,
                    due: '',
                    notes: '',
                    completed: false
                };

                console.log('üöÄ Quick Add: Creating task item:', { type: type, item: taskItem });

                // Add to Supabase - real-time subscription will update local state
                var success = await addTaskToSupabase(type, taskItem);

                if (success) {
                    showToast(t('itemAdded', { name: name }));
                    console.log('‚úÖ Quick Add: Task item added, real-time will sync');
                    // Note: Don't add to local state here - real-time subscription handles it
                } else {
                    console.error('‚ùå Quick Add: Task item not added due to database error');
                }
            }
        }

        function openManageModal(type) {
            state.currentManageType = type;
            var titles = {
                shopping: t('shoppingQuickAdd'),
                tasks: t('tasksQuickAdd'),
                clifford: t('cliffordQuickAdd')
            };
            document.getElementById('modal-manage-title').textContent = titles[type];
            document.getElementById('new-standard-name').value = '';
            renderManageList();
            document.getElementById('modal-manage').classList.add('open');
            document.getElementById('modal-manage').setAttribute('aria-hidden', 'false');
        }

        function addStandardItem() {
            var input = document.getElementById('new-standard-name');
            var name = input.value.trim();
            if (name) {
                state.quickAdd[state.currentManageType].push(name);
                input.value = '';
                saveData();
                addQuickAddToSupabase(state.currentManageType, name);
                renderManageList();
                renderQuickButtons(state.currentManageType);
            }
        }

        function removeStandardItem(index) {
            var type = state.currentManageType;
            var name = state.quickAdd[type][index];
            state.quickAdd[type].splice(index, 1);
            saveData();
            removeQuickAddFromSupabase(type, name);
            renderManageList();
            renderQuickButtons(type);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('open');
            document.getElementById(modalId).setAttribute('aria-hidden', 'true');
        }

        // ========================================
        // FORM HANDLERS
        // ========================================
        function setupForms() {
            // Shopping form
            var btnAddShopping = document.getElementById('btn-add-shopping');
            var formShopping = document.getElementById('form-shopping');
            var btnCancelShopping = document.getElementById('btn-cancel-shopping');

            btnAddShopping.addEventListener('click', function() {
                formShopping.classList.toggle('open');
                btnAddShopping.setAttribute('aria-expanded', formShopping.classList.contains('open'));
            });

            btnCancelShopping.addEventListener('click', function() {
                formShopping.classList.remove('open');
                formShopping.reset();
                btnAddShopping.setAttribute('aria-expanded', 'false');
            });

            formShopping.addEventListener('submit', async function(e) {
                e.preventDefault();
                var name = document.getElementById('shopping-name').value.trim();
                if (!name) return;

                var item = {
                    id: generateId(),
                    name: name,
                    notes: document.getElementById('shopping-notes').value.trim(),
                    completed: false
                };

                console.log('üìù Manual shopping form submit:', item);

                // Add to Supabase - real-time subscription will update local state
                var success = await addShoppingToSupabase(item);

                if (success) {
                    formShopping.reset();
                    formShopping.classList.remove('open');
                    btnAddShopping.setAttribute('aria-expanded', 'false');
                    showToast(t('itemAdded', { name: name }));
                    console.log('‚úÖ Manual shopping form: Item added, real-time will sync');
                    // Note: Don't add to local state here - real-time subscription handles it
                } else {
                    console.error('‚ùå Manual shopping form: Item not added due to database error');
                }
            });

            // Tasks form
            var btnAddTask = document.getElementById('btn-add-task');
            var formTask = document.getElementById('form-task');
            var btnCancelTask = document.getElementById('btn-cancel-task');

            btnAddTask.addEventListener('click', function() {
                formTask.classList.toggle('open');
                btnAddTask.setAttribute('aria-expanded', formTask.classList.contains('open'));
            });

            btnCancelTask.addEventListener('click', function() {
                formTask.classList.remove('open');
                formTask.reset();
                btnAddTask.setAttribute('aria-expanded', 'false');
            });

            formTask.addEventListener('submit', async function(e) {
                e.preventDefault();
                var name = document.getElementById('task-name').value.trim();
                if (!name) return;

                var item = {
                    id: generateId(),
                    name: name,
                    assignee: document.getElementById('task-assignee').value,
                    due: document.getElementById('task-due').value,
                    notes: document.getElementById('task-notes').value.trim(),
                    completed: false
                };

                console.log('üìù Manual task form submit:', item);

                // Add to Supabase - real-time subscription will update local state
                var success = await addTaskToSupabase('tasks', item);

                if (success) {
                    formTask.reset();
                    formTask.classList.remove('open');
                    btnAddTask.setAttribute('aria-expanded', 'false');
                    showToast(t('itemAdded', { name: name }));
                    console.log('‚úÖ Manual task form: Item added, real-time will sync');
                    // Note: Don't add to local state here - real-time subscription handles it
                } else {
                    console.error('‚ùå Manual task form: Item not added due to database error');
                }
            });

            // Clifford form
            var btnAddClifford = document.getElementById('btn-add-clifford');
            var formClifford = document.getElementById('form-clifford');
            var btnCancelClifford = document.getElementById('btn-cancel-clifford');

            btnAddClifford.addEventListener('click', function() {
                formClifford.classList.toggle('open');
                btnAddClifford.setAttribute('aria-expanded', formClifford.classList.contains('open'));
            });

            btnCancelClifford.addEventListener('click', function() {
                formClifford.classList.remove('open');
                formClifford.reset();
                btnAddClifford.setAttribute('aria-expanded', 'false');
            });

            formClifford.addEventListener('submit', async function(e) {
                e.preventDefault();
                var name = document.getElementById('clifford-name').value.trim();
                if (!name) return;

                var item = {
                    id: generateId(),
                    name: name,
                    assignee: document.getElementById('clifford-assignee').value,
                    due: document.getElementById('clifford-due').value,
                    notes: document.getElementById('clifford-notes').value.trim(),
                    completed: false
                };

                console.log('üìù Manual Clifford form submit:', item);

                // Add to Supabase - real-time subscription will update local state
                var success = await addTaskToSupabase('clifford', item);

                if (success) {
                    formClifford.reset();
                    formClifford.classList.remove('open');
                    btnAddClifford.setAttribute('aria-expanded', 'false');
                    showToast(t('itemAdded', { name: name }));
                    console.log('‚úÖ Manual Clifford form: Item added, real-time will sync');
                    // Note: Don't add to local state here - real-time subscription handles it
                } else {
                    console.error('‚ùå Manual Clifford form: Item not added due to database error');
                }
            });
        }

        // ========================================
        // NAVIGATION
        // ========================================
        function setupNavigation() {
            var navBtns = document.querySelectorAll('.nav-btn');

            navBtns.forEach(function(btn) {
                btn.addEventListener('click', function() {
                    navigateToPage(btn.dataset.page);
                });
            });
        }

        // ========================================
        // SETTINGS HANDLERS
        // ========================================
        function setupSettings() {
            var languageSelect = document.getElementById('language-select');
            var themeSelect = document.getElementById('theme-select');

            languageSelect.value = state.language;
            themeSelect.value = state.theme;

            languageSelect.addEventListener('change', function() {
                setLanguage(this.value);
            });

            themeSelect.addEventListener('change', function() {
                setTheme(this.value);
            });
        }

        // ========================================
        // MODAL HANDLERS
        // ========================================
        function setupModals() {
            // Edit modal
            document.querySelector('#modal-edit .modal-close').addEventListener('click', function() { closeModal('modal-edit'); });
            document.getElementById('btn-cancel-edit').addEventListener('click', function() { closeModal('modal-edit'); });
            document.getElementById('form-edit-item').addEventListener('submit', function(e) {
                e.preventDefault();
                saveEditedItem();
            });

            // Manage modal
            document.querySelector('#modal-manage .modal-close').addEventListener('click', function() { closeModal('modal-manage'); });
            document.getElementById('btn-add-standard').addEventListener('click', addStandardItem);
            document.getElementById('new-standard-name').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addStandardItem();
            });

            // Manage buttons
            document.getElementById('manage-shopping-standards').addEventListener('click', function() { openManageModal('shopping'); });
            document.getElementById('manage-tasks-standards').addEventListener('click', function() { openManageModal('tasks'); });
            document.getElementById('manage-clifford-standards').addEventListener('click', function() { openManageModal('clifford'); });

            // Settings page manage buttons
            document.getElementById('settings-shopping-standards').addEventListener('click', function() { openManageModal('shopping'); });
            document.getElementById('settings-tasks-standards').addEventListener('click', function() { openManageModal('tasks'); });
            document.getElementById('settings-clifford-standards').addEventListener('click', function() { openManageModal('clifford'); });

            // Close modals on overlay click
            document.querySelectorAll('.modal-overlay').forEach(function(overlay) {
                overlay.addEventListener('click', function(e) {
                    if (e.target === overlay) {
                        overlay.classList.remove('open');
                        overlay.setAttribute('aria-hidden', 'true');
                    }
                });
            });

            // Close modals on Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal-overlay.open').forEach(function(modal) {
                        modal.classList.remove('open');
                        modal.setAttribute('aria-hidden', 'true');
                    });
                }
            });
        }

        // ========================================
        // AUTH UI HANDLERS
        // ========================================
        function setupAuthUI() {
            // Login form
            document.getElementById('login-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                hideAuthError();
                var btn = document.getElementById('login-btn');
                btn.classList.add('loading');
                btn.innerHTML = '<span class="loading-spinner"></span> Signing in...';

                var success = await handleLogin(
                    document.getElementById('login-email').value,
                    document.getElementById('login-password').value
                );

                btn.classList.remove('loading');
                btn.textContent = 'Sign In';
            });

            // Signup form
            document.getElementById('signup-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                hideAuthError();
                var btn = document.getElementById('signup-btn');
                btn.classList.add('loading');
                btn.innerHTML = '<span class="loading-spinner"></span> Creating account...';

                var success = await handleSignup(
                    document.getElementById('signup-email').value,
                    document.getElementById('signup-password').value,
                    document.getElementById('signup-name').value
                );

                btn.classList.remove('loading');
                btn.textContent = 'Create Account';
            });

            // Switch between login/signup
            document.getElementById('switch-to-signup').addEventListener('click', function() {
                var loginForm = document.getElementById('login-form');
                var signupForm = document.getElementById('signup-form');
                var switchText = document.getElementById('switch-text');
                var switchBtn = document.getElementById('switch-to-signup');
                var subtitle = document.getElementById('auth-subtitle');
                hideAuthError();

                if (loginForm.classList.contains('hidden')) {
                    loginForm.classList.remove('hidden');
                    signupForm.classList.add('hidden');
                    switchText.textContent = "Don't have an account?";
                    switchBtn.textContent = 'Sign Up';
                    subtitle.textContent = 'Sign in to manage your household';
                } else {
                    loginForm.classList.add('hidden');
                    signupForm.classList.remove('hidden');
                    switchText.textContent = 'Already have an account?';
                    switchBtn.textContent = 'Sign In';
                    subtitle.textContent = 'Create your account';
                }
            });

            // Household setup
            document.getElementById('create-household-btn').addEventListener('click', function() {
                document.getElementById('household-choice').classList.add('hidden');
                document.getElementById('create-household-form').classList.remove('hidden');
            });

            document.getElementById('join-household-btn').addEventListener('click', function() {
                document.getElementById('household-choice').classList.add('hidden');
                document.getElementById('join-household-form').classList.remove('hidden');
            });

            document.getElementById('back-to-choice').addEventListener('click', function() {
                document.getElementById('create-household-form').classList.add('hidden');
                document.getElementById('household-choice').classList.remove('hidden');
            });

            document.getElementById('back-to-choice-2').addEventListener('click', function() {
                document.getElementById('join-household-form').classList.add('hidden');
                document.getElementById('household-choice').classList.remove('hidden');
            });

            // Create household form
            document.getElementById('create-household-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                hideAuthError();
                var householdName = document.getElementById('household-name').value.trim();
                if (!householdName) return;

                var household = await createHousehold(householdName);
                if (household) {
                    state.household = household;
                    document.getElementById('create-household-form').classList.add('hidden');
                    document.getElementById('household-created').classList.remove('hidden');
                    document.getElementById('invite-code-display').textContent = household.invite_code;
                }
            });

            // Continue to app
            document.getElementById('continue-to-app').addEventListener('click', async function() {
                await loadFromSupabase();
                await setupRealtimeSubscriptions();
                showMainApp();
                renderAll();
                setupNavigation();
                setupForms();
                setupModals();
                setupSettings();
            });

            // Join household form
            document.getElementById('join-household-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                hideAuthError();
                var code = document.getElementById('invite-code').value.trim();
                if (!code) return;

                var household = await joinHousehold(code);
                if (household) {
                    state.household = household;
                    await loadFromSupabase();
                    await setupRealtimeSubscriptions();
                    showMainApp();
                    renderAll();
                    setupNavigation();
                    setupForms();
                    setupModals();
                    setupSettings();
                }
            });

            // Logout button
            document.getElementById('btn-logout').addEventListener('click', handleLogout);
        }

        // ========================================
        // INITIALIZATION
        // ========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ App initializing...');

            // Debug: Check localStorage for session data
            console.log('üîç Checking localStorage...');
            const authKey = localStorage.getItem('hoi-supabase-auth');
            if (authKey) {
                console.log('‚úÖ Auth data found in localStorage');
                try {
                    const authData = JSON.parse(authKey);
                    console.log('üì¶ Session expires at:', authData?.expires_at ? new Date(authData.expires_at * 1000) : 'Unknown');
                } catch (e) {
                    console.log('‚ö†Ô∏è Could not parse auth data');
                }
            } else {
                console.log('‚ÑπÔ∏è No auth data in localStorage');
            }

            applyTheme();
            applyLanguage();
            setupAuthUI();
            setupDebugPanelTrigger();

            // Check for existing session
            if (supabase) {
                try {
                    console.log('üîç Checking for existing session...');
                    const { data: sessionData, error } = await supabase.auth.getSession();

                    if (error) {
                        console.error('‚ùå Session check error:', error);
                        showAuthScreen();
                        return;
                    }

                    if (sessionData && sessionData.session) {
                        console.log('‚úÖ Found existing session for user:', sessionData.session.user.email);
                        state.user = sessionData.session.user;

                        // Check if user has a household
                        var household = await getUserHousehold();
                        if (household) {
                            console.log('‚úÖ User has household:', household.name);
                            state.household = household;
                            await loadFromSupabase();
                            await setupRealtimeSubscriptions();
                            showMainApp();
                            renderAll();
                            setupNavigation();
                            setupForms();
                            setupModals();
                            setupSettings();
                        } else {
                            console.log('‚ö†Ô∏è User has no household, showing setup...');
                            showHouseholdSetup();
                        }
                    } else {
                        console.log('‚ÑπÔ∏è No existing session found, showing auth screen');
                        showAuthScreen();
                    }
                } catch (error) {
                    console.error('‚ùå Initialization error:', error);
                    showAuthScreen();
                }

                // Listen for auth changes
                supabase.auth.onAuthStateChange(async function(event, session) {
                    console.log('üîê Auth state changed:', event);

                    if (event === 'SIGNED_IN' && session) {
                        state.user = session.user;
                        var household = await getUserHousehold();
                        if (household) {
                            state.household = household;
                            await loadFromSupabase();
                            await setupRealtimeSubscriptions();
                            showMainApp();
                            renderAll();
                            setupNavigation();
                            setupForms();
                            setupModals();
                            setupSettings();
                        } else {
                            showHouseholdSetup();
                        }
                    } else if (event === 'TOKEN_REFRESHED' && session) {
                        // Update user session when token refreshes
                        state.user = session.user;
                        console.log('‚úÖ Session token refreshed');
                    } else if (event === 'SIGNED_OUT') {
                        showAuthScreen();
                    }
                });
            } else {
                // Supabase not available - show auth screen
                showAuthScreen();
            }

            // Online/offline detection
            window.addEventListener('online', async function() {
                console.log('üåê App came online');
                state.isOnline = true;
                if (state.household && state.user && supabase) {
                    try {
                        // Refresh session first when coming back online
                        console.log('üîÑ Refreshing session after coming online...');
                        await ensureFreshSession();

                        // Then reload data
                        await loadFromSupabase();

                        // Reconnect realtime
                        console.log('üîÑ Reconnecting realtime after coming online...');
                        await checkRealtimeHealth();

                        showSyncStatus('synced', 'Back online');
                    } catch (error) {
                        console.error('‚ùå Error reconnecting after coming online:', error);
                        showSyncStatus('offline', 'Reconnection failed');
                    }
                }
            });

            window.addEventListener('offline', function() {
                console.log('üì¥ App went offline');
                state.isOnline = false;
                showSyncStatus('offline', 'Offline');
                // Clear reconnect timer when offline
                if (realtimeReconnectTimer) {
                    clearTimeout(realtimeReconnectTimer);
                    realtimeReconnectTimer = null;
                }
            });

            // Periodic health check for realtime connection and session refresh
            // Check every 30 seconds to ensure connection is alive
            setInterval(async function() {
                if (state.user && state.household && supabase && !document.hidden && state.isOnline) {
                    try {
                        const now = Date.now();
                        const timeSinceLastOp = state._lastSuccessfulOperation ? (now - state._lastSuccessfulOperation) : Infinity;
                        const FIVE_MINUTES = 5 * 60 * 1000;

                        // Proactively refresh if no successful operation in 5 minutes
                        if (timeSinceLastOp > FIVE_MINUTES) {
                            console.log('‚ö†Ô∏è No successful operations in 5 minutes, proactively refreshing session...');
                            await ensureFreshSession();
                        }

                        // Regular session refresh check
                        console.log('üîÑ Periodic health check...');
                        await ensureFreshSession();

                        // Then check realtime health
                        await checkRealtimeHealth();
                    } catch (error) {
                        console.error('‚ùå Periodic health check failed:', error);
                    }
                }
            }, 30000); // 30 seconds

            // Handle page visibility - track hidden time and wake up app if needed
            document.addEventListener('visibilitychange', async function() {
                if (!document.hidden && supabase && state.user && state.household) {
                    // App became visible
                    const now = Date.now();
                    const hiddenDuration = state._lastHiddenAt ? (now - state._lastHiddenAt) : 0;

                    console.log('üëÅÔ∏è App became visible, hidden for:', Math.round(hiddenDuration / 1000) + 's');
                    debugLog('Visibility: App became visible', 'info', { hiddenDuration: Math.round(hiddenDuration / 1000) + 's' });
                    showSyncStatus('syncing', 'Reconnecting...');

                    try {
                        // ALWAYS do a full wake up when coming back from background
                        // Mobile apps can lose connection even after brief switches
                        console.log('üåÖ Doing full wake up after app switch...');
                        debugLog('Visibility: Starting wake up', 'info');
                        await wakeUpApp();
                        console.log('‚úÖ App wake up complete');
                        debugLog('Visibility: Wake up successful', 'success');
                    } catch (e) {
                        console.error('‚ùå Error during app visibility recovery:', e);
                        debugLog('Visibility: Wake up failed', 'error', { error: e.message });
                        showSyncStatus('offline', 'Connection error - tap to retry');

                        // If wakeup failed, try a simpler recovery
                        try {
                            console.log('üîÑ Trying simpler recovery...');
                            debugLog('Visibility: Attempting simple recovery', 'warning');
                            await ensureFreshSession();
                            await setupRealtimeSubscriptions();
                            showSyncStatus('synced', 'Reconnected');
                            debugLog('Visibility: Simple recovery successful', 'success');
                        } catch (e2) {
                            console.error('‚ùå Simple recovery also failed:', e2);
                            debugLog('Visibility: Simple recovery failed', 'error', { error: e2.message });
                            showSyncStatus('offline', 'Connection failed - please refresh');
                        }
                    }
                } else if (document.hidden) {
                    // App became hidden - track when
                    state._lastHiddenAt = Date.now();
                    console.log('üåô App became hidden at', new Date().toLocaleTimeString());
                    debugLog('Visibility: App became hidden', 'info', { time: new Date().toLocaleTimeString() });

                    // When page is hidden, clear any pending reconnect timers
                    if (realtimeReconnectTimer) {
                        console.log('‚è∏Ô∏è Page hidden, pausing reconnect attempts');
                        debugLog('Visibility: Pausing reconnect attempts', 'info');
                        clearTimeout(realtimeReconnectTimer);
                        realtimeReconnectTimer = null;
                    }
                }
            });
        });

        // ========================================
        // PWA FUNCTIONALITY
        // ========================================

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('./sw.js')
                    .then(function(registration) {
                        console.log('‚úÖ ServiceWorker registered:', registration.scope);

                        // Check for updates
                        registration.addEventListener('updatefound', function() {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', function() {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('üîÑ New version available! Refresh to update.');
                                    // Optionally show a toast notification here
                                }
                            });
                        });
                    })
                    .catch(function(error) {
                        console.log('‚ùå ServiceWorker registration failed:', error);
                    });
            });
        }

        // Install Button Functionality
        let deferredPrompt;
        const installBtn = document.getElementById('pwa-install-btn');
        const installBtnSettings = document.getElementById('pwa-install-btn-settings');

        window.addEventListener('beforeinstallprompt', function(e) {
            console.log('üì≤ Install prompt available');
            e.preventDefault();
            deferredPrompt = e;

            // Show install button
            if (installBtn) installBtn.classList.remove('hidden');
        });

        function handleInstall() {
            if (!deferredPrompt) {
                alert('App is already installed or installation not available on this device.');
                return;
            }

            deferredPrompt.prompt();
            deferredPrompt.userChoice.then(function(choiceResult) {
                if (choiceResult.outcome === 'accepted') {
                    console.log('‚úÖ User accepted install');
                } else {
                    console.log('‚ùå User dismissed install');
                }
                deferredPrompt = null;
                if (installBtn) installBtn.classList.add('hidden');
            });
        }

        if (installBtn) {
            installBtn.addEventListener('click', handleInstall);
        }

        if (installBtnSettings) {
            installBtnSettings.addEventListener('click', handleInstall);
        }

        window.addEventListener('appinstalled', function() {
            console.log('‚úÖ App installed successfully');
            deferredPrompt = null;
            if (installBtn) installBtn.classList.add('hidden');
        });

        // Push Notification Functionality
        const notificationBtn = document.getElementById('pwa-notification-btn');
        const notificationStatus = document.getElementById('notification-status');

        function updateNotificationStatus() {
            if (!('Notification' in window)) {
                notificationStatus.textContent = 'Not Supported';
                if (notificationBtn) notificationBtn.disabled = true;
                return;
            }

            const permission = Notification.permission;
            if (permission === 'granted') {
                notificationStatus.textContent = 'Enabled ‚úì';
            } else if (permission === 'denied') {
                notificationStatus.textContent = 'Blocked';
            } else {
                notificationStatus.textContent = 'Enable Notifications';
            }
        }

        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                alert('Notifications are not supported in this browser.');
                return;
            }

            if (Notification.permission === 'granted') {
                // Test notification
                new Notification('Thibault', {
                    body: 'Notifications are enabled! You will receive updates for tasks and shopping items.',
                    icon: './icons/icon-192x192.png',
                    badge: './icons/icon-72x72.png'
                });
                return;
            }

            if (Notification.permission === 'denied') {
                alert('Notifications are blocked. Please enable them in your browser settings.');
                return;
            }

            try {
                const permission = await Notification.requestPermission();
                updateNotificationStatus();

                if (permission === 'granted') {
                    // Subscribe to push notifications
                    const registration = await navigator.serviceWorker.ready;

                    // Check if push manager is available
                    if ('pushManager' in registration) {
                        try {
                            // For now, just show a notification
                            new Notification('Thibault', {
                                body: 'Notifications enabled! You will receive updates.',
                                icon: './icons/icon-192x192.png',
                                badge: './icons/icon-72x72.png'
                            });

                            // TODO: Subscribe to push service
                            // const subscription = await registration.pushManager.subscribe({
                            //     userVisibleOnly: true,
                            //     applicationServerKey: 'YOUR_PUBLIC_VAPID_KEY'
                            // });
                            // Send subscription to server
                        } catch (error) {
                            console.log('Push subscription error:', error);
                        }
                    }
                }
            } catch (error) {
                console.error('Notification permission error:', error);
            }
        }

        if (notificationBtn) {
            notificationBtn.addEventListener('click', requestNotificationPermission);
        }

        // Update notification status on load
        document.addEventListener('DOMContentLoaded', function() {
            updateNotificationStatus();
        });
    </script>

</body>
</html>
